<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Поиск лучших компаний по нише</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f1117;
      color: #e1e4e8;
      min-height: 100vh;
      padding-top: 50px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 8px;
      color: #fff;
    }

    .subtitle {
      text-align: center;
      color: #8b949e;
      margin-bottom: 32px;
      font-size: 15px;
    }

    .form-section {
      max-width: 600px;
      margin: 0 auto 40px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-group label {
      font-size: 13px;
      color: #8b949e;
      font-weight: 500;
    }

    input[type="text"], input[type="password"] {
      padding: 12px 16px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #161b22;
      color: #e1e4e8;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: #58a6ff;
    }

    select {
      padding: 12px 16px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #161b22;
      color: #e1e4e8;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
      cursor: pointer;
    }

    .field-hint {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
      line-height: 1.4;
    }

    /* === Style Selector === */
    .style-selector { margin-top: 4px; }
    .style-filter-bar { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .style-filter-btn {
      padding: 4px 12px; border-radius: 14px; border: 1px solid #30363d;
      background: transparent; color: #8b949e; font-size: 12px; cursor: pointer;
      transition: all 0.15s;
    }
    .style-filter-btn:hover { border-color: #58a6ff; color: #58a6ff; }
    .style-filter-btn.active { background: #1f6feb; border-color: #1f6feb; color: #fff; }
    .style-cards-track {
      display: flex; gap: 10px; overflow-x: auto; padding: 4px 0 8px;
      scrollbar-width: thin; scrollbar-color: #30363d transparent;
    }
    .style-cards-track::-webkit-scrollbar { height: 6px; }
    .style-cards-track::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
    .style-card {
      flex: 0 0 120px; height: 160px; border-radius: 8px; border: 2px solid #30363d;
      background: #161b22; cursor: pointer; overflow: hidden; position: relative;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .style-card:hover { border-color: #58a6ff; }
    .style-card.selected { border-color: #58a6ff; box-shadow: 0 0 0 2px rgba(88,166,255,0.3); }
    .style-card-auto {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 8px; color: #8b949e; font-size: 12px;
    }
    .style-card-auto .auto-icon { font-size: 28px; opacity: 0.7; }
    .style-card-preview {
      width: 100%; height: 120px; overflow: hidden; pointer-events: none;
    }
    .style-card-label {
      padding: 4px 6px; font-size: 9px; color: #c9d1d9; line-height: 1.2;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      background: rgba(13,17,23,0.85); position: absolute; bottom: 0; left: 0; right: 0;
      text-align: center;
    }
    /* Mini-preview inside style card */
    .sp-mini { transform: scale(0.22); transform-origin: top left; width: 545px; pointer-events: none; }
    .sp-mini .sp-hero { padding: 16px 20px; border-radius: 6px 6px 0 0; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
    .sp-mini .sp-hero h2 { font-size: 18px; margin: 0 0 4px; }
    .sp-mini .sp-hero p { font-size: 11px; margin: 0; opacity: 0.85; }
    .sp-mini .sp-row { display: flex; align-items: center; gap: 8px; padding: 6px 10px; font-size: 10px; }
    .sp-mini .sp-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .sp-mini .sp-bar { height: 6px; border-radius: 3px; flex: 1; }
    .sp-mini .sp-score { font-size: 10px; font-weight: 600; min-width: 24px; text-align: right; }

    .prompt-preview {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      color: #8b949e;
      line-height: 1.6;
    }

    .prompt-preview .highlight {
      color: #58a6ff;
      font-weight: 600;
    }

    button {
      padding: 12px 24px;
      background: #238636;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover { background: #2ea043; }
    button:disabled {
      background: #21262d;
      color: #484f58;
      cursor: not-allowed;
    }

    .results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }

    .result-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .result-header {
      padding: 16px 20px;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .model-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    .badge-chatgpt { background: #10a37f; }
    .badge-gemini { background: #4285f4; }
    .badge-claude { background: #d97706; }

    .model-name {
      font-weight: 600;
      font-size: 15px;
    }

    .chat-messages {
      padding: 0;
      max-height: 600px;
      overflow-y: auto;
      flex: 1;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 3px;
    }

    .chat-msg {
      padding: 14px 20px;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      border-bottom: 1px solid #1c2129;
    }

    .chat-msg-user {
      background: #1c2333;
    }

    .chat-msg-user .chat-msg-label {
      color: #58a6ff;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .chat-msg-assistant .chat-msg-label {
      color: #8b949e;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .error-text { color: #f85149; }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid #30363d;
      background: #0d1117;
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #161b22;
      color: #e1e4e8;
      font-size: 14px;
      outline: none;
    }

    .chat-input-area input:focus {
      border-color: #58a6ff;
    }

    .chat-input-area button {
      padding: 10px 16px;
      font-size: 13px;
      white-space: nowrap;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 40px;
      color: #8b949e;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .spinner-small {
      width: 14px;
      height: 14px;
      border: 2px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .grok-table-wrap table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .grok-table-wrap th {
      background: #1c2333;
      color: #58a6ff;
      text-align: left;
      padding: 10px 14px;
      border: 1px solid #30363d;
      font-weight: 600;
    }

    .grok-table-wrap td {
      padding: 10px 14px;
      border: 1px solid #30363d;
      line-height: 1.5;
    }

    .grok-table-wrap tr:nth-child(even) {
      background: #161b22;
    }

    .grok-table-wrap tr:nth-child(odd) {
      background: #0d1117;
    }

    .xml-output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-x: auto;
      color: #e1e4e8;
    }

    .xml-output .xml-tag { color: #7ee787; }
    .xml-output .xml-attr { color: #d2a8ff; }
    .xml-output .xml-val { color: #a5d6ff; }
    .xml-output .xml-text { color: #e1e4e8; }

    .copy-btn {
      padding: 6px 14px;
      font-size: 12px;
      background: #21262d;
      color: #8b949e;
      border: 1px solid #30363d;
      border-radius: 6px;
      cursor: pointer;
      float: right;
      margin-bottom: 10px;
    }

    .copy-btn:hover {
      background: #30363d;
      color: #e1e4e8;
    }

    .canvas-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      border-bottom: 1px solid #30363d;
      background: #0d1117;
    }

    .canvas-tabs {
      display: flex;
      gap: 4px;
    }

    .canvas-tab {
      padding: 6px 16px;
      font-size: 13px;
      background: transparent;
      color: #8b949e;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .canvas-tab:hover {
      color: #e1e4e8;
      background: #161b22;
    }

    .canvas-tab.active {
      background: #238636;
      color: #fff;
      border-color: #238636;
    }

    .canvas-frame {
      width: 100%;
      min-height: 800px;
      border: none;
      background: #fff;
      border-radius: 0 0 12px 12px;
    }

    .canvas-code {
      background: #0d1117;
      padding: 20px;
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #e1e4e8;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 800px;
      overflow-y: auto;
      margin: 0;
    }

    .companies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .company-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e1e4e8;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      text-align: left;
      width: 100%;
    }

    .company-btn:hover { border-color: #58a6ff; background: #1c2333; }
    .company-btn.status-done { border-color: #238636; }
    .company-btn.status-error { border-color: #f85149; }
    .company-btn.status-loading { border-color: #d29922; }

    .company-status-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .company-status-icon.pending { background: #484f58; }
    .company-status-icon.loading { background: #d29922; animation: pulse 1s infinite; }
    .company-status-icon.done { background: #238636; }
    .company-status-icon.error { background: #f85149; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .company-preview-frame {
      width: 100%;
      height: 500px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #fff;
    }

    .fill-section {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .fill-section textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #161b22;
      color: #e1e4e8;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      outline: none;
    }

    .fill-section textarea:focus { border-color: #58a6ff; }
    .fill-section textarea::placeholder { color: #484f58; }

    .download-progress {
      font-size: 13px;
      color: #8b949e;
      margin-bottom: 8px;
    }

    .api-key-toggle {
      font-size: 12px;
      color: #58a6ff;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      font-weight: 400;
    }

    .api-key-toggle:hover {
      text-decoration: underline;
      background: none;
    }

    /* --- Editor toolbar --- */
    .editor-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      flex-wrap: wrap;
    }

    .editor-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #8b949e;
      cursor: pointer;
      user-select: none;
    }

    .editor-toggle input[type="checkbox"] {
      accent-color: #238636;
      width: 16px;
      height: 16px;
    }

    .editor-btn {
      padding: 4px 12px;
      font-size: 12px;
      background: #21262d;
      color: #8b949e;
      border: 1px solid #30363d;
      border-radius: 6px;
      cursor: pointer;
    }

    .editor-btn:hover:not(:disabled) {
      background: #30363d;
      color: #e1e4e8;
    }

    .editor-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .editor-btn-primary {
      background: #238636;
      color: #fff;
      border-color: #238636;
    }

    .editor-btn-primary:hover {
      background: #2ea043;
    }

    /* --- SEO Panel --- */
    .seo-panel {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
      display: none;
    }

    .seo-panel h3 {
      font-size: 16px;
      color: #e1e4e8;
      margin-bottom: 16px;
    }

    .seo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .seo-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .seo-field.full-width {
      grid-column: 1 / -1;
    }

    .seo-field label {
      font-size: 13px;
      color: #8b949e;
      font-weight: 500;
    }

    .seo-field input,
    .seo-field textarea {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #e1e4e8;
      padding: 8px 12px;
      font-size: 13px;
      font-family: inherit;
    }

    .seo-field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .seo-field .field-hint {
      color: #6e7681;
      font-size: 11px;
    }

    .seo-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .seo-notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #238636;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 10000;
      animation: fadeInOut 2.5s ease forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      15% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Projects list */
    .projects-section {
      margin-bottom: 32px;
      border: 1px solid #30363d;
      border-radius: 12px;
      background: #161b22;
      overflow: hidden;
    }
    .projects-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #1c2128;
      border-bottom: 1px solid #30363d;
      cursor: pointer;
    }
    .projects-header h2 {
      font-size: 16px;
      color: #fff;
      margin: 0;
    }
    .projects-header .toggle-arrow {
      color: #8b949e;
      font-size: 14px;
      transition: transform 0.2s;
    }
    .projects-header .toggle-arrow.open {
      transform: rotate(180deg);
    }
    .projects-list {
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .projects-list:empty::after {
      content: 'Нет сохранённых проектов';
      color: #8b949e;
      font-size: 13px;
      padding: 20px;
      text-align: center;
      grid-column: 1 / -1;
    }
    .project-card {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 14px;
      transition: border-color 0.2s;
    }
    .project-card:hover {
      border-color: #58a6ff;
    }
    .project-card .pc-niche {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .project-card .pc-geo {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 8px;
    }
    .project-card .pc-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .project-card .pc-date {
      font-size: 11px;
      color: #6e7681;
    }
    .project-card .pc-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 500;
    }
    .pc-status.in_progress { background: #1f2d3d; color: #58a6ff; }
    .pc-status.generated { background: #1a2e1a; color: #3fb950; }
    .pc-status.filled { background: #2d1f3d; color: #bc8cff; }
    .pc-status.edited { background: #2d2a1f; color: #d29922; }
    .project-card .pc-actions {
      display: flex;
      gap: 6px;
    }
    .project-card .pc-actions button {
      flex: 1;
      padding: 5px 8px;
      font-size: 11px;
      border: 1px solid #30363d;
      border-radius: 6px;
      background: #21262d;
      color: #c9d1d9;
      cursor: pointer;
      transition: background 0.15s;
    }
    .project-card .pc-actions button:hover {
      background: #30363d;
    }
    .project-card .pc-actions button.pc-open {
      background: #238636;
      border-color: #238636;
      color: #fff;
    }
    .project-card .pc-actions button.pc-open:hover {
      background: #2ea043;
    }
    .project-card .pc-actions button.pc-delete:hover {
      background: #da3633;
      border-color: #da3633;
      color: #fff;
    }

    /* === SPA Navigation === */
    #app-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      height: 50px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
    }
    .nav-inner {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-logo {
      font-size: 18px;
      font-weight: 700;
      color: #58a6ff;
      text-decoration: none;
      letter-spacing: 1px;
    }
    .nav-logo:hover { color: #79c0ff; }
    .nav-links { display: flex; gap: 4px; }
    .nav-link {
      padding: 8px 16px;
      font-size: 13px;
      color: #8b949e;
      text-decoration: none;
      border-radius: 6px;
      transition: background 0.15s, color 0.15s;
    }
    .nav-link:hover { background: #21262d; color: #e1e4e8; }
    .nav-link.active { background: #238636; color: #fff; }
    .screen-hidden { display: none !important; }

    /* === Dashboard === */
    #screen-dashboard {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .dashboard-header h1 { font-size: 24px; text-align: left; }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .dashboard-empty {
      text-align: center;
      padding: 80px 20px;
      color: #8b949e;
    }
    .dashboard-empty p { font-size: 15px; margin-bottom: 20px; }

    /* === Project View === */
    #screen-project {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .project-header { margin-bottom: 24px; }
    .project-header h1 { font-size: 24px; text-align: left; margin-bottom: 8px; }
    .project-header-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      color: #8b949e;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .project-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .project-actions button { padding: 8px 16px; font-size: 13px; }
    .project-preview-frame {
      width: 100%;
      min-height: 600px;
      border: 1px solid #30363d;
      border-radius: 12px;
      background: #fff;
    }
    .project-meta-section {
      margin-top: 24px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
    }
    .project-meta-section summary {
      padding: 12px 16px;
      cursor: pointer;
      color: #8b949e;
      font-size: 13px;
      list-style: none;
    }
    .project-meta-section summary::-webkit-details-marker { display: none; }
    .project-meta-section[open] summary { border-bottom: 1px solid #30363d; }
    .project-meta-content {
      padding: 16px;
      font-size: 13px;
      color: #8b949e;
    }

    /* === Pipeline Timeline === */
    .pipeline-timeline {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pipeline-step {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      background: #21262d;
      color: #8b949e;
      border: 1px solid #30363d;
      white-space: nowrap;
      transition: all 0.3s;
    }
    .pipeline-step.done { background: #0d1117; color: #3fb950; border-color: #238636; }
    .pipeline-step.running { background: #0d1117; color: #d29922; border-color: #9e6a03; }
    .pipeline-step.error { background: #0d1117; color: #f85149; border-color: #da3633; }
    .pipeline-arrow { color: #30363d; font-size: 14px; }

    /* === Project Pipeline Results === */
    .project-pipeline-results { margin-top: 24px; }
    .project-pipeline-results .result-card { margin-bottom: 16px; }

    .project-result-actions {
      display: flex;
      gap: 8px;
      margin: 24px 0;
      flex-wrap: wrap;
    }
    .project-result-actions button { padding: 8px 16px; font-size: 13px; }

    .project-resume-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #161b22;
      border: 1px solid #9e6a03;
      border-radius: 12px;
      margin-bottom: 24px;
      color: #d29922;
      font-size: 14px;
    }
    .project-resume-bar button { white-space: nowrap; }
  </style>
</head>
<body>
  <nav id="app-nav">
    <div class="nav-inner">
      <a href="#/" class="nav-logo">NRG</a>
      <div class="nav-links">
        <a href="#/" class="nav-link" id="nav-link-dashboard">Проекты</a>
        <a href="#/generator" class="nav-link" id="nav-link-generator">Новый проект</a>
      </div>
    </div>
  </nav>

  <div id="screen-dashboard" class="screen-hidden"></div>

  <div id="screen-generator" class="screen-hidden">
  <div class="container">
    <h1>30 лучших компаний по нише</h1>
    <p class="subtitle">Введите нишу — получите списки от трёх нейросетей через OpenRouter</p>

    <div class="form-section">
      <div class="input-group">
        <label>
          API-ключ OpenRouter
          <button class="api-key-toggle" onclick="toggleApiKey()" id="toggleBtn">показать</button>
        </label>
        <input type="password" id="apiKey" placeholder="sk-or-..." />
      </div>

      <div class="input-group">
        <label>Название ниши</label>
        <input type="text" id="niche" placeholder="например: кибербезопасность" oninput="updatePreview()" />
        <span class="field-hint">Укажите нишу или тематику для поиска компаний. Пример: аренда авто, кибербезопасность</span>
      </div>

      <div class="input-group">
        <label>Гео ниши <span style="color:#8b949e; font-weight:400;">(необязательно)</span></label>
        <input type="text" id="geo" placeholder="например: Москва, Россия, Казахстан..." oninput="updatePreview()" />
        <span class="field-hint">Где работают компании. Оставьте пустым для глобального поиска. Пример: Калифорния, Москва</span>
      </div>

      <div class="input-group">
        <label>Гео запроса <span style="color:#8b949e; font-weight:400;">(необязательно)</span></label>
        <input type="text" id="geoRequest" placeholder="например: Москва, New York..." />
        <span class="field-hint">Откуда вы ищете — влияет на релевантность выдачи с учётом вашей локации. Пример: Москва, New York</span>
      </div>

      <div class="input-group">
        <label>Язык запросов</label>
        <select id="queryLang">
          <option value="Русский">Русский</option>
          <option value="English">English</option>
          <option value="Deutsch">Deutsch</option>
          <option value="Français">Français</option>
          <option value="Español">Español</option>
          <option value="中文">中文</option>
          <option value="日本語">日本語</option>
        </select>
        <span class="field-hint">На каком языке модели будут искать и анализировать компании</span>
      </div>

      <div class="input-group">
        <label>Язык сайта</label>
        <select id="siteLang">
          <option value="Русский">Русский</option>
          <option value="English">English</option>
          <option value="Deutsch">Deutsch</option>
          <option value="Français">Français</option>
          <option value="Español">Español</option>
          <option value="中文">中文</option>
          <option value="日本語">日本語</option>
        </select>
        <span class="field-hint">На каком языке будет сгенерирован итоговый рейтинговый сайт</span>
      </div>

      <div class="input-group">
        <label>Данные вашей компании <span style="color:#8b949e; font-weight:400;">(необязательно)</span></label>
        <textarea id="user-company-data" placeholder="Название компании, описание услуг, преимущества, цены, отзывы клиентов..." style="min-height:80px;"></textarea>
        <span class="field-hint">Если указать — компания станет #1 в итоговом рейтинге с бейджем «Выбор редакции»</span>
      </div>

      <div class="input-group">
        <label>Стиль дизайна</label>
        <div class="style-selector">
          <div class="style-filter-bar" id="styleFilterBar"></div>
          <div class="style-cards-track" id="styleCardsTrack"></div>
        </div>
        <input type="hidden" id="designStyle" value="auto" />
        <span class="field-hint">Выберите стиль или оставьте «Автоподбор» — система подберёт по нише</span>
      </div>

      <div class="prompt-preview" id="preview">
        Составь список 30 <span class="highlight">...</span>
      </div>

      <button id="searchBtn" onclick="startProject()" style="width:100%;">Создать проект</button>

      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; display:flex; justify-content:space-between; align-items:center;">
        <details style="flex:1;">
          <summary style="cursor:pointer; font-size:13px; color:#8b949e;">Быстрый тест загрузки</summary>
          <div style="margin-top: 8px; display:flex; gap:8px;">
            <input type="text" id="testUrl" placeholder="https://example.com" style="flex:1;" />
            <button onclick="testDownload()" style="white-space:nowrap;">Тест</button>
          </div>
          <div id="testResult" style="margin-top:8px; font-size:12px; color:#8b949e; white-space:pre-wrap;"></div>
        </details>
        <a href="test-download.html" style="font-size:13px; color:#58a6ff; text-decoration:none; margin-left:12px;">Полный тест скачивания →</a>
      </div>
    </div>

  </div>
  </div><!-- /screen-generator -->

  <div id="screen-project" class="screen-hidden"></div>

  <script>
    // === Projects: localStorage ===
    let currentProjectId = null;
    // Projects stored on server via /api/projects

    // === DESIGN_STYLES: 58 styles from styles.json ===
    const DESIGN_STYLES = [
      {"id":1,"name":"Minimalism & Swiss Style","type":"General","keywords":"Clean, simple, spacious, functional, white space, high contrast, geometric, sans-serif, grid-based, essential","primaryColors":"Monochromatic, Black #000000, White #FFFFFF","secondaryColors":"Neutral (Beige #F5F1E8, Grey #808080, Taupe #B38B6D), Primary accent","effects":"Subtle hover (200-250ms), smooth transitions, sharp shadows if any, clear type hierarchy, fast loading","bestFor":"Enterprise apps, dashboards, documentation sites, SaaS platforms, professional tools","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":2,"name":"Neumorphism","type":"General","keywords":"Soft UI, embossed, debossed, convex, concave, light source, subtle depth, rounded (12-16px), monochromatic","primaryColors":"Light pastels: Soft Blue #C8E0F4, Soft Pink #F5E0E8, Soft Grey #E8E8E8","secondaryColors":"Tints/shades (±30%), gradient subtlety, color harmony","effects":"Soft box-shadow (multiple: -5px -5px 15px, 5px 5px 15px), smooth press (150ms), inner subtle shadow","bestFor":"Health/wellness apps, meditation platforms, fitness trackers, minimal interaction UIs","performance":"⚡ Good","accessibility":"⚠ Low contrast"},
      {"id":3,"name":"Glassmorphism","type":"General","keywords":"Frosted glass, transparent, blurred background, layered, vibrant background, light source, depth, multi-layer","primaryColors":"Translucent white: rgba(255,255,255,0.1-0.3)","secondaryColors":"Vibrant: Electric Blue #0080FF, Neon Purple #8B00FF, Vivid Pink #FF1493, Teal #20B2AA","effects":"Backdrop blur (10-20px), subtle border (1px solid rgba white 0.2), light reflection, Z-depth","bestFor":"Modern SaaS, financial dashboards, high-end corporate, lifestyle apps","performance":"⚠ Good","accessibility":"⚠ Ensure 4.5:1"},
      {"id":4,"name":"Brutalism","type":"General","keywords":"Raw, unpolished, stark, high contrast, plain text, default fonts, visible borders, asymmetric, anti-design","primaryColors":"Primary: Red #FF0000, Blue #0000FF, Yellow #FFFF00, Black #000000, White #FFFFFF","secondaryColors":"Limited: Neon Green #00FF00, Hot Pink #FF00FF, minimal secondary","effects":"No smooth transitions (instant), sharp corners (0px), bold typography (700+), visible grid, large blocks","bestFor":"Design portfolios, artistic projects, counter-culture brands, editorial/media sites","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":5,"name":"3D & Hyperrealism","type":"General","keywords":"Depth, realistic textures, 3D models, spatial navigation, tactile, skeuomorphic elements, rich detail, immersive","primaryColors":"Deep Navy #001F3F, Forest Green #228B22, Burgundy #800020, Gold #FFD700, Silver #C0C0C0","secondaryColors":"Complex gradients (5-10 stops), realistic lighting, shadow variations (20-40% darker)","effects":"WebGL/Three.js 3D, realistic shadows (layers), physics lighting, parallax (3-5 layers), smooth 3D (300-400ms)","bestFor":"Gaming, product showcase, immersive experiences, high-end e-commerce","performance":"❌ Poor","accessibility":"⚠ Not accessible"},
      {"id":6,"name":"Vibrant & Block-based","type":"General","keywords":"Bold, energetic, playful, block layout, geometric shapes, high color contrast, duotone, modern, energetic","primaryColors":"Neon Green #39FF14, Electric Purple #BF00FF, Vivid Pink #FF1493, Bright Cyan #00FFFF, Sunburst #FFAA00","secondaryColors":"Complementary: Orange #FF7F00, Shocking Pink #FF006E, Lime #CCFF00, triadic schemes","effects":"Large sections (48px+ gaps), animated patterns, bold hover (color shift), scroll-snap, large type (32px+)","bestFor":"Startups, creative agencies, gaming, social media, youth-focused, entertainment","performance":"⚡ Good","accessibility":"◐ Ensure WCAG"},
      {"id":7,"name":"Dark Mode (OLED)","type":"General","keywords":"Dark theme, low light, high contrast, deep black, midnight blue, eye-friendly, OLED, night mode","primaryColors":"Deep Black #000000, Dark Grey #121212, Midnight Blue #0A0E27","secondaryColors":"Vibrant accents: Neon Green #39FF14, Electric Blue #0080FF, Gold #FFD700, Plasma Purple #BF00FF","effects":"Minimal glow (text-shadow: 0 0 10px), dark-to-light transitions, low white emission, high readability","bestFor":"Night-mode apps, coding platforms, entertainment, eye-strain prevention, OLED devices","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":8,"name":"Accessible & Ethical","type":"General","keywords":"High contrast, large text (16px+), keyboard navigation, screen reader friendly, WCAG compliant, semantic","primaryColors":"WCAG AA/AAA (4.5:1 min), simple primary, clear secondary, high luminosity (7:1+)","secondaryColors":"Symbol-based colors (not color-only), supporting patterns, inclusive combinations","effects":"Clear focus rings (3-4px), ARIA labels, skip links, responsive design, reduced motion, 44x44px touch targets","bestFor":"Government, healthcare, education, inclusive products, legal compliance, public","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":9,"name":"Claymorphism","type":"General","keywords":"Soft 3D, chunky, playful, toy-like, bubbly, thick borders (3-4px), double shadows, rounded (16-24px)","primaryColors":"Pastel: Soft Peach #FDBCB4, Baby Blue #ADD8E6, Mint #98FF98, Lilac #E6E6FA","secondaryColors":"Soft gradients (pastel-to-pastel), light/dark variations (20-30%), gradient subtle","effects":"Inner+outer shadows (subtle, no hard lines), soft press (200ms ease-out), fluffy elements","bestFor":"Educational apps, children's apps, SaaS platforms, creative tools, fun-focused","performance":"⚡ Good","accessibility":"⚠ Ensure 4.5:1"},
      {"id":10,"name":"Aurora UI","type":"General","keywords":"Vibrant gradients, smooth blend, Northern Lights effect, mesh gradient, luminous, atmospheric, abstract","primaryColors":"Complementary: Blue-Orange, Purple-Yellow, Electric Blue #0080FF, Magenta #FF1493, Cyan #00FFFF","secondaryColors":"Smooth transitions (Blue→Purple→Pink→Teal), iridescent effects, blend modes","effects":"Large flowing CSS/SVG gradients, subtle 8-12s animations, depth via color layering, smooth morph","bestFor":"Modern SaaS, creative agencies, branding, music platforms, lifestyle, premium products","performance":"⚠ Good","accessibility":"⚠ Text contrast"},
      {"id":11,"name":"Retro-Futurism","type":"General","keywords":"Vintage sci-fi, 80s aesthetic, neon glow, geometric patterns, CRT scanlines, pixel art, cyberpunk, synthwave","primaryColors":"Neon Blue #0080FF, Hot Pink #FF006E, Cyan #00FFFF, Deep Black #1A1A2E, Purple #5D34D0","secondaryColors":"Metallic Silver #C0C0C0, Gold #FFD700, duotone, 80s Pink #FF10F0, neon accents","effects":"CRT scanlines (::before overlay), neon glow (text-shadow+box-shadow), glitch effects","bestFor":"Gaming, entertainment, music platforms, tech brands, artistic projects, cyberpunk","performance":"⚠ Moderate","accessibility":"⚠ High contrast/strain"},
      {"id":12,"name":"Flat Design","type":"General","keywords":"2D, minimalist, bold colors, no shadows, clean lines, simple shapes, typography-focused, modern, icon-heavy","primaryColors":"Solid bright: Red, Orange, Blue, Green, limited palette (4-6 max)","secondaryColors":"Complementary colors, muted secondaries, high saturation, clean accents","effects":"No gradients/shadows, simple hover (color/opacity shift), fast loading, clean transitions (150-200ms)","bestFor":"Web apps, mobile apps, cross-platform, startup MVPs, SaaS, dashboards, corporate","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":13,"name":"Skeuomorphism","type":"General","keywords":"Realistic, texture, depth, 3D appearance, real-world metaphors, shadows, gradients, tactile, detailed","primaryColors":"Rich realistic: wood, leather, metal colors, detailed gradients (8-12 stops)","secondaryColors":"Realistic lighting gradients, shadow variations (30-50% darker), texture overlays","effects":"Realistic shadows (layers), depth (perspective), texture details (noise, grain), realistic animations","bestFor":"Legacy apps, gaming, immersive storytelling, premium products, luxury","performance":"❌ Poor","accessibility":"⚠ Textures reduce readability"},
      {"id":14,"name":"Liquid Glass","type":"General","keywords":"Flowing glass, morphing, smooth transitions, fluid effects, translucent, animated blur, iridescent","primaryColors":"Vibrant iridescent (rainbow spectrum), translucent base with opacity shifts","secondaryColors":"Chromatic aberration (Red-Cyan), iridescent oil-spill, fluid gradient blends, holographic","effects":"Morphing elements (SVG/CSS), fluid animations (400-600ms curves), dynamic blur, color transitions","bestFor":"Premium SaaS, high-end e-commerce, creative platforms, branding experiences","performance":"⚠ Moderate-Poor","accessibility":"⚠ Text contrast"},
      {"id":15,"name":"Motion-Driven","type":"General","keywords":"Animation-heavy, microinteractions, smooth transitions, scroll effects, parallax, entrance anim, page transitions","primaryColors":"Bold colors emphasize movement, high contrast animated, dynamic gradients","secondaryColors":"Transitional states, success (Green #22C55E), error (Red #EF4444), neutral feedback","effects":"Scroll anim (Intersection Observer), hover (300-400ms), entrance, parallax (3-5 layers)","bestFor":"Portfolio sites, storytelling platforms, interactive experiences, entertainment apps","performance":"⚠ Good","accessibility":"⚠ Prefers-reduced-motion"},
      {"id":16,"name":"Micro-interactions","type":"General","keywords":"Small animations, gesture-based, tactile feedback, subtle animations, contextual interactions, responsive","primaryColors":"Subtle color shifts (10-20%), feedback: Green #22C55E, Red #EF4444, Amber #F59E0B","secondaryColors":"Accent feedback, neutral supporting, clear action indicators","effects":"Small hover (50-100ms), loading spinners, success/error state anim, gesture-triggered","bestFor":"Mobile apps, touchscreen UIs, productivity tools, consumer apps","performance":"⚡ Excellent","accessibility":"✓ Good"},
      {"id":17,"name":"Inclusive Design","type":"General","keywords":"Accessible, color-blind friendly, high contrast, haptic feedback, voice interaction, screen reader, universal","primaryColors":"WCAG AAA (7:1+ contrast), avoid red-green only, symbol-based indicators","secondaryColors":"Supporting patterns (stripes, dots, hatch), symbols, non-color indicators","effects":"Haptic feedback (vibration), voice guidance, focus indicators (4px+ ring), motion options","bestFor":"Public services, education, healthcare, finance, government, inclusive consumer","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":18,"name":"Zero Interface","type":"General","keywords":"Minimal visible UI, voice-first, gesture-based, AI-driven, invisible controls, predictive, ambient","primaryColors":"Neutral backgrounds: Soft white #FAFAFA, light grey #F0F0F0, warm off-white #F5F1E8","secondaryColors":"Subtle feedback: light green, light red, minimal UI elements, soft accents","effects":"Voice recognition UI, gesture detection, AI predictions, progressive disclosure, smart suggestions","bestFor":"Voice assistants, AI platforms, smart home, contextual computing","performance":"⚡ Excellent","accessibility":"✓ Excellent"},
      {"id":19,"name":"Soft UI Evolution","type":"General","keywords":"Evolved soft UI, better contrast, modern aesthetics, subtle depth, accessibility-focused, improved shadows","primaryColors":"Improved contrast pastels: Soft Blue #87CEEB, Soft Pink #FFB6C1, Soft Green #90EE90","secondaryColors":"Better combinations, accessible secondary, supporting with improved contrast","effects":"Improved shadows (softer than flat, clearer than neumorphism), modern (200-300ms), WCAG AA/AAA","bestFor":"Modern enterprise apps, SaaS platforms, health/wellness, modern business tools","performance":"⚡ Excellent","accessibility":"✓ WCAG AA+"},
      {"id":20,"name":"Hero-Centric Design","type":"Landing Page","keywords":"Large hero section, compelling headline, high-contrast CTA, product showcase, value proposition","primaryColors":"Brand primary color, white/light backgrounds for contrast, accent color for CTA","secondaryColors":"Supporting colors for secondary CTAs, accent highlights, trust elements","effects":"Smooth scroll reveal, fade-in animations on hero, subtle background parallax, CTA glow/pulse","bestFor":"SaaS landing pages, product launches, service landing pages, B2B platforms","performance":"⚡ Good","accessibility":"✓ WCAG AA"},
      {"id":21,"name":"Conversion-Optimized","type":"Landing Page","keywords":"Form-focused, minimalist design, single CTA focus, high contrast, urgency elements, trust signals","primaryColors":"Primary brand color, high-contrast white/light backgrounds, urgency colors","secondaryColors":"Secondary CTA color (muted), trust element colors, accent for key benefits","effects":"Hover states on CTA (color shift, slight scale), form field focus animations, success feedback","bestFor":"E-commerce product pages, free trial signups, lead generation, SaaS pricing pages","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":22,"name":"Feature-Rich Showcase","type":"Landing Page","keywords":"Multiple feature sections, grid layout, benefit cards, visual feature demonstrations, interactive elements","primaryColors":"Primary brand, bright secondary colors for feature cards, contrasting accent for CTAs","secondaryColors":"Benefits (green), problems (red/orange), features (blue/purple), social proof (neutral)","effects":"Card hover effects (lift/scale), icon animations on scroll, feature toggle animations","bestFor":"Enterprise SaaS, software tools landing pages, platform services, B2B products","performance":"⚡ Good","accessibility":"✓ WCAG AA"},
      {"id":23,"name":"Minimal & Direct","type":"Landing Page","keywords":"Minimal text, white space heavy, single column layout, direct messaging, clean typography, fast-loading","primaryColors":"Monochromatic primary, white background, single accent color for CTA","secondaryColors":"Minimal secondary colors, reserved for critical CTAs only, neutral supporting","effects":"Very subtle hover effects, minimal animations, fast page load, smooth scroll","bestFor":"Simple service landing pages, indie products, consulting, micro SaaS","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":24,"name":"Social Proof-Focused","type":"Landing Page","keywords":"Testimonials prominent, client logos displayed, case studies, reviews/ratings, credibility markers","primaryColors":"Primary brand, trust colors (blue), success/growth colors (green), neutral backgrounds","secondaryColors":"Testimonial highlight colors, logo grid backgrounds, badge/achievement colors","effects":"Testimonial carousel animations, logo grid fade-in, stat counter animations, review ratings","bestFor":"B2B SaaS, professional services, premium products, established brands","performance":"⚡ Good","accessibility":"✓ WCAG AA"},
      {"id":25,"name":"Interactive Product Demo","type":"Landing Page","keywords":"Embedded product mockup/video, interactive elements, product walkthrough, step-by-step guides","primaryColors":"Primary brand, interface colors matching product, demo highlight colors","secondaryColors":"Product UI colors, tutorial step colors, hover state indicators","effects":"Product animation playback, step progression animations, hover reveal effects, smooth zoom","bestFor":"SaaS platforms, tool/software products, productivity apps, developer tools","performance":"⚠ Good (video/interactive)","accessibility":"✓ WCAG AA"},
      {"id":26,"name":"Trust & Authority","type":"Landing Page","keywords":"Certificates/badges displayed, expert credentials, case studies with metrics, security badges","primaryColors":"Professional colors (blue/grey), trust colors, certification badge colors (gold/silver)","secondaryColors":"Certificate highlight colors, metric showcase colors, comparison highlight (success green)","effects":"Badge hover effects, metric pulse animations, certificate carousel, smooth stat reveal","bestFor":"Healthcare, financial services, enterprise software, premium/luxury products, legal","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":27,"name":"Storytelling-Driven","type":"Landing Page","keywords":"Narrative flow, visual story progression, section transitions, emotional messaging, journey visualization","primaryColors":"Brand primary, warm/emotional colors, varied accent colors per story section","secondaryColors":"Story section color coding, emotional state colors, transitional gradients","effects":"Section-to-section animations, scroll-triggered reveals, morphing transitions, parallax narrative","bestFor":"Brand/startup stories, mission-driven products, premium/lifestyle brands, educational","performance":"⚠ Moderate (animations)","accessibility":"✓ WCAG AA"},
      {"id":28,"name":"Data-Dense Dashboard","type":"BI/Analytics","keywords":"Multiple charts/widgets, data tables, KPI cards, minimal padding, grid layout, space-efficient","primaryColors":"Neutral primary (#F5F5F5), data colors (blue/green/red), dark text #333333","secondaryColors":"Chart colors: success (green #22C55E), warning (amber #F59E0B), alert (red #EF4444)","effects":"Hover tooltips, chart zoom on click, row highlighting, smooth filter animations, data loading spinners","bestFor":"Business intelligence dashboards, financial analytics, enterprise reporting","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":29,"name":"Heat Map & Heatmap Style","type":"BI/Analytics","keywords":"Color-coded grid/matrix, data intensity visualization, geographical heat maps, correlation matrices","primaryColors":"Gradient scale: Cool (blue #0080FF) to hot (red #FF0000), neutral middle (white/yellow)","secondaryColors":"Cool-to-hot gradients, divergent for positive/negative, monochromatic options","effects":"Color gradient transitions on data change, cell highlighting on hover, tooltip reveal","bestFor":"Geographical analysis, performance matrices, correlation analysis, user behavior heatmaps","performance":"⚡ Excellent","accessibility":"⚠ Colorblind considerations"},
      {"id":30,"name":"Executive Dashboard","type":"BI/Analytics","keywords":"High-level KPIs, large key metrics, minimal detail, summary view, trend indicators, at-a-glance","primaryColors":"Brand colors, professional palette (blue/grey/white), accent for KPIs, red for alerts","secondaryColors":"KPI highlight: positive (green), negative (red), neutral (grey), trend arrow colors","effects":"KPI value animations (count-up), trend arrow animations, metric card hover lift, alert pulse","bestFor":"C-suite dashboards, business summary reports, decision-maker dashboards","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":31,"name":"Real-Time Monitoring","type":"BI/Analytics","keywords":"Live data updates, status indicators, alert notifications, streaming data visualization","primaryColors":"Alert: critical (red #FF0000), warning (orange #FFA500), normal (green #22C55E), updating (blue)","secondaryColors":"Status indicator colors, chart line colors varying by metric, streaming highlights","effects":"Real-time chart animations, alert pulse/glow, status indicator blink, smooth data updates","bestFor":"System monitoring dashboards, DevOps, real-time analytics, stock market dashboards","performance":"⚡ Good (real-time load)","accessibility":"✓ WCAG AA"},
      {"id":32,"name":"Drill-Down Analytics","type":"BI/Analytics","keywords":"Hierarchical data exploration, expandable sections, interactive drill-down paths, context preservation","primaryColors":"Primary brand, breadcrumb colors, drill-level indicator colors, hierarchy depth colors","secondaryColors":"Drill-down path indicators, level-specific colors, highlight for selected level","effects":"Drill-down expand animations, breadcrumb transitions, smooth detail reveal, data reload animation","bestFor":"Sales analytics, product analytics, funnel analysis, multi-dimensional exploration","performance":"⚡ Good","accessibility":"✓ WCAG AA"},
      {"id":33,"name":"Comparative Analysis Dashboard","type":"BI/Analytics","keywords":"Side-by-side comparisons, period-over-period metrics, A/B test results, benchmarks","primaryColors":"Comparison: primary (blue), comparison (orange/purple), delta indicator (green/red)","secondaryColors":"Winning (green), losing (red), neutral comparison (grey), benchmark colors","effects":"Comparison bar animations, delta indicator animations, highlight on compare","bestFor":"Period-over-period reporting, A/B test dashboards, market comparison, competitive analysis","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":34,"name":"Predictive Analytics","type":"BI/Analytics","keywords":"Forecast lines, confidence intervals, trend projections, scenario modeling, anomaly detection","primaryColors":"Forecast line color (distinct from actual), confidence interval shading, anomaly highlight (red)","secondaryColors":"High confidence (dark), low confidence (light), anomaly (red/orange), normal trend (green/blue)","effects":"Forecast line animation, confidence band fade-in, anomaly pulse alert, smoothing animations","bestFor":"Forecasting dashboards, anomaly detection, trend prediction, AI-powered analytics","performance":"⚠ Good (computation)","accessibility":"✓ WCAG AA"},
      {"id":35,"name":"User Behavior Analytics","type":"BI/Analytics","keywords":"Funnel visualization, user flow diagrams, conversion tracking, engagement metrics, cohort analysis","primaryColors":"Funnel: high engagement (green), drop-off (red), conversion (blue), flow arrows (grey)","secondaryColors":"Stage completion (success), abandonment (warning), engagement levels (gradient), cohort colors","effects":"Funnel animation (fill-down), flow diagram animations, conversion pulse, engagement bar fill","bestFor":"Conversion funnel analysis, user journey tracking, engagement analytics, retention tracking","performance":"⚡ Good","accessibility":"✓ WCAG AA"},
      {"id":36,"name":"Financial Dashboard","type":"BI/Analytics","keywords":"Revenue metrics, profit/loss visualization, budget tracking, financial ratios, portfolio performance","primaryColors":"Profit (green #22C55E), loss (red #EF4444), neutral (grey), trust (dark blue #003366)","secondaryColors":"Revenue (green), expenses (red), budget variance (orange/red), balance (grey)","effects":"Number animations (count-up), trend direction indicators, profit/loss color transitions","bestFor":"Financial reporting, accounting dashboards, portfolio tracking, budget monitoring","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":37,"name":"Sales Intelligence Dashboard","type":"BI/Analytics","keywords":"Deal pipeline, sales metrics, territory performance, leaderboard, win-loss analysis, quota tracking","primaryColors":"Won (green), lost (red), in-progress (blue), blocked (orange), quota met (gold)","secondaryColors":"Pipeline stage colors, rep performance colors, quota achievement, forecast accuracy colors","effects":"Deal movement animations, leaderboard ranking changes, gauge needle movements, status highlights","bestFor":"CRM dashboards, sales management, opportunity tracking, performance management","performance":"⚡ Good","accessibility":"✓ WCAG AA"},
      {"id":38,"name":"Neubrutalism","type":"General","keywords":"Bold borders, black outlines, primary colors, thick shadows, no gradients, flat colors, 45° shadows, Gen Z","primaryColors":"#FFEB3B (Yellow), #FF5252 (Red), #2196F3 (Blue), #000000 (Black borders)","secondaryColors":"Limited accent colors, high contrast combinations, no gradients allowed","effects":"box-shadow: 4px 4px 0 #000, border: 3px solid #000, no gradients, sharp corners, bold typography","bestFor":"Gen Z brands, startups, creative agencies, Figma-style apps, Notion-style, tech blogs","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":39,"name":"Bento Box Grid","type":"General","keywords":"Modular cards, asymmetric grid, varied sizes, Apple-style, dashboard tiles, negative space, clean hierarchy","primaryColors":"Neutral base + brand accent, #FFFFFF, #F5F5F5, brand primary","secondaryColors":"Subtle gradients, shadow variations, accent highlights for interactive cards","effects":"grid-template with varied spans, rounded-xl (16px), subtle shadows, hover scale (1.02)","bestFor":"Dashboards, product pages, portfolios, Apple-style marketing, feature showcases, SaaS","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":40,"name":"Y2K Aesthetic","type":"General","keywords":"Neon pink, chrome, metallic, bubblegum, iridescent, glossy, retro-futurism, 2000s","primaryColors":"#FF69B4 (Hot Pink), #00FFFF (Cyan), #C0C0C0 (Silver), #9400D3 (Purple)","secondaryColors":"Metallic gradients, glossy overlays, iridescent effects, chrome textures","effects":"linear-gradient metallic, glossy buttons, 3D chrome effects, glow animations, bubble shapes","bestFor":"Fashion brands, music platforms, Gen Z brands, nostalgia marketing, entertainment","performance":"⚠ Good","accessibility":"⚠ Check contrast"},
      {"id":41,"name":"Cyberpunk UI","type":"General","keywords":"Neon, dark mode, terminal, HUD, sci-fi, glitch, dystopian, futuristic, matrix, tech noir","primaryColors":"#00FF00 (Matrix Green), #FF00FF (Magenta), #00FFFF (Cyan), #0D0D0D (Dark)","secondaryColors":"Neon gradients, scanline overlays, glitch colors, terminal green accents","effects":"Neon glow (text-shadow), glitch animations (skew/offset), scanlines, terminal fonts","bestFor":"Gaming platforms, tech products, crypto apps, sci-fi applications, developer tools","performance":"⚠ Moderate","accessibility":"⚠ Limited (dark+neon)"},
      {"id":42,"name":"Organic Biophilic","type":"General","keywords":"Nature, organic shapes, green, sustainable, rounded, flowing, wellness, earthy, natural textures","primaryColors":"#228B22 (Forest Green), #8B4513 (Earth Brown), #87CEEB (Sky Blue), #F5F5DC (Beige)","secondaryColors":"Natural gradients, earth tones, sky blues, organic textures, wood/stone colors","effects":"Rounded corners (16-24px), organic curves, natural shadows, flowing SVG shapes","bestFor":"Wellness apps, sustainability brands, eco products, health apps, meditation","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":43,"name":"AI-Native UI","type":"General","keywords":"Chatbot, conversational, voice, assistant, agentic, ambient, minimal chrome, streaming text","primaryColors":"Neutral + single accent, #6366F1 (AI Purple), #10B981 (Success), #F5F5F5","secondaryColors":"Status indicators, streaming highlights, context card colors, subtle accent variations","effects":"Typing indicators (3-dot pulse), streaming text animations, pulse, context cards, smooth reveals","bestFor":"AI products, chatbots, voice assistants, copilots, AI-powered tools","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":44,"name":"Memphis Design","type":"General","keywords":"80s, geometric, playful, postmodern, shapes, patterns, squiggles, triangles, neon, bold","primaryColors":"#FF71CE (Hot Pink), #FFCE5C (Yellow), #86CCCA (Teal), #6A7BB4 (Blue Purple)","secondaryColors":"Complementary geometric colors, pattern fills, contrasting accent shapes","effects":"transform: rotate(), clip-path: polygon(), mix-blend-mode, repeating patterns, bold shapes","bestFor":"Creative agencies, music sites, youth brands, event promotion, artistic portfolios","performance":"⚡ Excellent","accessibility":"⚠ Check contrast"},
      {"id":45,"name":"Vaporwave","type":"General","keywords":"Synthwave, retro-futuristic, 80s-90s, neon, glitch, nostalgic, sunset gradient, dreamy, aesthetic","primaryColors":"#FF71CE (Pink), #01CDFE (Cyan), #05FFA1 (Mint), #B967FF (Purple)","secondaryColors":"Sunset gradients, glitch overlays, VHS effects, neon accents, pastel variations","effects":"text-shadow glow, linear-gradient, filter: hue-rotate(), glitch animations, retro scan lines","bestFor":"Music platforms, gaming, creative portfolios, tech startups, entertainment","performance":"⚠ Moderate","accessibility":"⚠ Poor (motion)"},
      {"id":46,"name":"Dimensional Layering","type":"General","keywords":"Depth, overlapping, z-index, layers, 3D, shadows, elevation, floating, cards, spatial hierarchy","primaryColors":"Neutral base (#FFFFFF, #F5F5F5, #E0E0E0) + brand accent for elevated elements","secondaryColors":"Shadow variations (sm/md/lg/xl), elevation colors, highlight colors for top layers","effects":"z-index stacking, box-shadow elevation (4 levels), transform: translateZ(), backdrop-filter","bestFor":"Dashboards, card layouts, modals, navigation, product showcases, SaaS interfaces","performance":"⚠ Good","accessibility":"⚠ Moderate (SR issues)"},
      {"id":47,"name":"Exaggerated Minimalism","type":"General","keywords":"Bold minimalism, oversized typography, high contrast, negative space, loud minimal, statement design","primaryColors":"#000000 (Black), #FFFFFF (White), single vibrant accent only","secondaryColors":"Minimal - single accent color, no secondary colors, extreme restraint","effects":"font-size: clamp(3rem 10vw 12rem), font-weight: 900, letter-spacing: -0.05em, massive whitespace","bestFor":"Fashion, architecture, portfolios, agency landing pages, luxury brands, editorial","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":48,"name":"Kinetic Typography","type":"General","keywords":"Motion text, animated type, moving letters, dynamic, typing effect, morphing, scroll-triggered text","primaryColors":"Flexible - high contrast, bold colors for emphasis, animation-friendly palette","secondaryColors":"Accent colors for emphasis, transition colors, gradient text fills","effects":"@keyframes text animation, typing effect, background-clip: text, GSAP ScrollTrigger","bestFor":"Hero sections, marketing sites, video platforms, storytelling, creative portfolios","performance":"⚠ Moderate","accessibility":"❌ Poor (motion)"},
      {"id":49,"name":"Parallax Storytelling","type":"General","keywords":"Scroll-driven, narrative, layered scrolling, immersive, progressive disclosure, cinematic","primaryColors":"Story-dependent, often gradients and natural colors, section-specific palettes","secondaryColors":"Section transition colors, depth layer colors, narrative mood colors","effects":"transform: translateY(scroll), position: fixed/sticky, perspective: 1px, scroll-triggered","bestFor":"Brand storytelling, product launches, case studies, portfolios, annual reports","performance":"❌ Poor","accessibility":"❌ Poor (motion)"},
      {"id":50,"name":"Swiss Modernism 2.0","type":"General","keywords":"Grid system, Helvetica, modular, asymmetric, international style, rational, clean, mathematical spacing","primaryColors":"#000000, #FFFFFF, #F5F5F5, single vibrant accent only","secondaryColors":"Minimal secondary, accent for emphasis only, no gradients","effects":"display: grid, 12-column grid, gap: 1rem, mathematical ratios, clear hierarchy","bestFor":"Corporate sites, architecture, editorial, SaaS, museums, professional services","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":51,"name":"HUD / Sci-Fi FUI","type":"General","keywords":"Futuristic, technical, wireframe, neon, data, transparency, sci-fi, interface","primaryColors":"Neon Cyan #00FFFF, Holographic Blue #0080FF, Alert Red #FF0000","secondaryColors":"Transparent Black, Grid Lines #333333","effects":"Glow effects, scanning animations, ticker text, blinking markers, fine line drawing","bestFor":"Sci-fi games, space tech, cybersecurity, immersive dashboards","performance":"⚠ Moderate (renders)","accessibility":"⚠ Poor (thin lines)"},
      {"id":52,"name":"Pixel Art","type":"General","keywords":"Retro, 8-bit, 16-bit, gaming, blocky, nostalgic, pixelated, arcade","primaryColors":"Primary colors (NES Palette), brights, limited palette","secondaryColors":"Black outlines, shading via dithering or block colors","effects":"Frame-by-frame sprite animation, blinking cursor, instant transitions, marquee text","bestFor":"Indie games, retro tools, creative portfolios, nostalgia marketing, Web3/NFT","performance":"⚡ Excellent","accessibility":"✓ Good (if contrast ok)"},
      {"id":53,"name":"Bento Grids","type":"General","keywords":"Apple-style, modular, cards, organized, clean, hierarchy, grid, rounded, soft","primaryColors":"Off-white #F5F5F7, Clean White #FFFFFF, Text #1D1D1F","secondaryColors":"Subtle accents, soft shadows, blurred backdrops","effects":"Hover scale (1.02), soft shadow expansion, smooth layout shifts, content reveal","bestFor":"Product features, dashboards, personal sites, marketing summaries, galleries","performance":"⚡ Excellent","accessibility":"✓ WCAG AA"},
      {"id":54,"name":"Neubrutalism","type":"General","keywords":"Bold, ugly-cute, raw, high contrast, flat, hard shadows, distinct, playful, loud","primaryColors":"Pop Yellow #FFDE59, Bright Red #FF5757, Black #000000","secondaryColors":"Lavender #CBA6F7, Mint #76E0C2","effects":"Hard hover shifts (4px), marquee scrolling, jitter animations, bold borders","bestFor":"Design tools, creative agencies, Gen Z brands, personal blogs","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":55,"name":"Spatial UI (VisionOS)","type":"General","keywords":"Glass, depth, immersion, spatial, translucent, gaze, gesture, apple, vision-pro","primaryColors":"Frosted Glass #FFFFFF (15-30% opacity), System White","secondaryColors":"Vibrant system colors for active states, deep shadows for depth","effects":"Parallax depth, dynamic lighting response, gaze-hover effects, smooth scale on focus","bestFor":"Spatial computing apps, VR/AR interfaces, immersive media, futuristic dashboards","performance":"⚠ Moderate (blur cost)","accessibility":"⚠ Contrast risks"},
      {"id":56,"name":"E-Ink / Paper","type":"General","keywords":"Paper-like, matte, high contrast, texture, reading, calm, slow tech, monochrome","primaryColors":"Off-White #FDFBF7, Paper White #F5F5F5, Ink Black #1A1A1A","secondaryColors":"Pencil Grey #4A4A4A, Highlighter Yellow #FFFF00 (accent)","effects":"No motion blur, distinct page turns, grain/noise texture, sharp transitions (no fade)","bestFor":"Reading apps, digital newspapers, minimal journals, distraction-free writing","performance":"⚡ Excellent","accessibility":"✓ WCAG AAA"},
      {"id":57,"name":"Gen Z Chaos / Maximalism","type":"General","keywords":"Chaos, clutter, stickers, raw, collage, mixed media, loud, internet culture, ironic","primaryColors":"Clashing Brights: #FF00FF, #00FF00, #FFFF00, #0000FF","secondaryColors":"Gradients, rainbow, glitch, noise, heavily saturated mix","effects":"Marquee scrolls, jitter, sticker layering, GIF overload, random placement","bestFor":"Gen Z lifestyle brands, music artists, creative portfolios, viral marketing","performance":"⚠ Poor (heavy assets)","accessibility":"❌ Poor"},
      {"id":58,"name":"Biomimetic / Organic 2.0","type":"General","keywords":"Nature-inspired, cellular, fluid, breathing, generative, algorithms, life-like","primaryColors":"Cellular Pink #FF9999, Chlorophyll Green #00FF41, Bioluminescent Blue","secondaryColors":"Deep Ocean #001E3C, Coral #FF7F50, Organic gradients","effects":"Breathing animations, fluid morphing, generative growth, physics-based movement","bestFor":"Sustainability tech, biotech, advanced health, meditation, generative art","performance":"⚠ Moderate","accessibility":"✓ Good"}
    ];

    // === Style Selector Logic ===
    function parseColorsFromString(colorStr) {
      const hexMatch = colorStr.match(/#[0-9A-Fa-f]{6}/g);
      return hexMatch ? hexMatch.slice(0, 5) : ['#58a6ff','#1f6feb','#238636','#da3633','#f0883e'];
    }

    function renderStylePreviewCard(style) {
      const colors = parseColorsFromString(style.primaryColors + ' ' + style.secondaryColors);
      const bg = colors[0] || '#1a1f35';
      const accent = colors[1] || '#58a6ff';
      const text = isLightColor(bg) ? '#1a1a2e' : '#ffffff';
      const barBg = isLightColor(bg) ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
      return `<div class="sp-mini">
        <div class="sp-hero" style="background:${bg};color:${text}">
          <h2 style="color:${text}">${style.name}</h2>
          <p style="color:${text}">${style.type}</p>
        </div>
        <div style="background:${isLightColor(bg) ? '#fff' : '#0d1117'}; padding:4px 0;">
          ${[9.4, 8.7, 8.1].map((score, i) => {
            const c = colors[i % colors.length] || accent;
            return `<div class="sp-row">
              <div class="sp-dot" style="background:${c}"></div>
              <div class="sp-bar" style="background:${barBg}"><div style="width:${score*10}%;height:100%;background:${c};border-radius:3px;"></div></div>
              <div class="sp-score" style="color:${text === '#ffffff' ? '#c9d1d9' : '#333'}">${score}</div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }

    function isLightColor(hex) {
      if (!hex || hex.charAt(0) !== '#') return false;
      const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16);
      return (r*299 + g*587 + b*114) / 1000 > 160;
    }

    let selectedDesignStyle = 'auto';

    function initStyleSelector() {
      const types = ['Все', 'General', 'Landing Page', 'BI/Analytics'];
      const filterBar = document.getElementById('styleFilterBar');
      const track = document.getElementById('styleCardsTrack');
      if (!filterBar || !track) return;

      filterBar.innerHTML = types.map(t =>
        `<button class="style-filter-btn${t === 'Все' ? ' active' : ''}" onclick="filterStyles('${t}')">${t}</button>`
      ).join('');

      renderStyleCards('Все');
    }

    function filterStyles(type) {
      document.querySelectorAll('.style-filter-btn').forEach(b => b.classList.toggle('active', b.textContent === type));
      renderStyleCards(type);
    }

    function renderStyleCards(filterType) {
      const track = document.getElementById('styleCardsTrack');
      if (!track) return;
      const filtered = filterType === 'Все' ? DESIGN_STYLES : DESIGN_STYLES.filter(s => s.type === filterType);

      let html = `<div class="style-card${selectedDesignStyle === 'auto' ? ' selected' : ''}" onclick="selectDesignStyle('auto')" data-style="auto">
        <div class="style-card-auto"><div class="auto-icon">🎯</div><div>Автоподбор</div></div>
      </div>`;

      html += filtered.map(s => `<div class="style-card${selectedDesignStyle === s.name ? ' selected' : ''}" onclick="selectDesignStyle('${s.name.replace(/'/g, "\\'")}')" data-style="${s.name}">
        <div class="style-card-preview">${renderStylePreviewCard(s)}</div>
        <div class="style-card-label">${s.name}</div>
      </div>`).join('');

      track.innerHTML = html;
    }

    function selectDesignStyle(name) {
      selectedDesignStyle = name;
      document.getElementById('designStyle').value = name;
      document.querySelectorAll('.style-card').forEach(c => c.classList.toggle('selected', c.dataset.style === name));
    }

    const STATUS_LABELS = {
      in_progress: 'Генерация',
      generated: 'Сгенерирован',
      filled: 'Наполнен',
      edited: 'Отредактирован'
    };

    // === SPA Router ===
    function router() {
      const hash = location.hash || '#/';

      // Hide all screens
      document.getElementById('screen-dashboard').classList.add('screen-hidden');
      document.getElementById('screen-generator').classList.add('screen-hidden');
      document.getElementById('screen-project').classList.add('screen-hidden');

      // Remove active state from nav links
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

      if (hash === '#/' || hash === '#' || hash === '') {
        document.getElementById('screen-dashboard').classList.remove('screen-hidden');
        document.getElementById('nav-link-dashboard').classList.add('active');
        renderDashboard();
      } else if (hash === '#/generator') {
        document.getElementById('screen-generator').classList.remove('screen-hidden');
        document.getElementById('nav-link-generator').classList.add('active');
        initStyleSelector();
      } else if (hash.startsWith('#/project/')) {
        const id = hash.split('/')[2];
        document.getElementById('screen-project').classList.remove('screen-hidden');
        document.getElementById('nav-link-dashboard').classList.add('active');
        renderProject(id);
      } else {
        location.hash = '#/';
      }
    }

    window.addEventListener('hashchange', router);

    // === Dashboard ===
    async function renderDashboard() {
      const projects = await getProjects();
      const container = document.getElementById('screen-dashboard');

      if (projects.length === 0) {
        container.innerHTML = `
          <div class="dashboard-header">
            <h1>Мои проекты</h1>
          </div>
          <div class="dashboard-empty">
            <p>У вас пока нет проектов</p>
            <button onclick="location.hash='#/generator'">Создать первый проект</button>
          </div>
        `;
        return;
      }

      const cardsHtml = projects.map(p => `
        <div class="project-card" data-id="${p.id}">
          <div class="pc-niche">${escHtml(p.niche)}</div>
          ${p.geo ? `<div class="pc-geo">${escHtml(p.geo)}</div>` : ''}
          <div class="pc-meta">
            <span class="pc-date">${new Date(p.updated_at || p.created_at).toLocaleDateString('ru-RU', {
              day: 'numeric', month: 'short', year: 'numeric'
            })}</span>
            <span class="pc-status ${p.status}">${STATUS_LABELS[p.status] || p.status}</span>
          </div>
          <div class="pc-actions">
            <button class="pc-open" onclick="location.hash='#/project/${p.id}'">Открыть</button>
            <button onclick="duplicateProject('${p.id}')">Дубл.</button>
            <button class="pc-delete" onclick="deleteProject('${p.id}')">Удалить</button>
          </div>
        </div>
      `).join('');

      container.innerHTML = `
        <div class="dashboard-header">
          <h1>Мои проекты <span style="color:#8b949e; font-weight:400;">(${projects.length})</span></h1>
          <button onclick="location.hash='#/generator'">+ Новый проект</button>
        </div>
        <div class="dashboard-grid">
          ${cardsHtml}
        </div>
      `;
    }

    async function getProjects() {
      try {
        const resp = await fetch('/api/projects');
        if (!resp.ok) { console.error('getProjects:', resp.status, await resp.text()); return []; }
        return await resp.json();
      } catch (e) { console.error('getProjects error:', e); return []; }
    }

    // BM25 + Design System moved to server-side bm25.js
    // === Pipeline Steps Definition ===
    const PIPELINE_STEPS = [
      { id: 'step_1_2', label: 'Списки + критерии' },
      { id: 'step_3', label: 'Дедупликация Grok' },
      { id: 'step_4', label: 'Аудитории Grok' },
      { id: 'step_design', label: 'Дизайн-система' },
      { id: 'step_5', label: 'XML-компилятор' },
      { id: 'step_6', label: 'Генерация сайта' },
      { id: 'step_7', label: 'Поиск рейтингов' },
      { id: 'step_8_web', label: 'Скачивание рейтингов' },
      { id: 'step_fill', label: 'Наполнение контентом' },
    ];

    function getStepState(stepId, currentStep, projectStatus) {
      const stepOrder = PIPELINE_STEPS.map(s => s.id);
      const currentIdx = stepOrder.indexOf(currentStep);
      const stepIdx = stepOrder.indexOf(stepId);
      if (projectStatus === 'generated' || projectStatus === 'filled' || projectStatus === 'edited') return 'done';
      if (currentIdx < 0) return stepIdx === 0 ? 'pending' : 'pending';
      if (stepIdx < currentIdx) return 'done';
      if (stepIdx === currentIdx) return 'done';
      return 'pending';
    }

    function renderTimeline(currentStep, projectStatus) {
      const icons = { pending: '⬚', done: '✅', running: '⏳', error: '❌' };
      return PIPELINE_STEPS.map((step, i) => {
        const state = getStepState(step.id, currentStep, projectStatus);
        return `${i > 0 ? '<span class="pipeline-arrow">→</span>' : ''}<div class="pipeline-step ${state}" id="timeline-${step.id}">${icons[state]} ${step.label}</div>`;
      }).join('');
    }

    function updateTimelineStep(stepId, state) {
      const icons = { pending: '⬚', done: '✅', running: '⏳', error: '❌' };
      const step = PIPELINE_STEPS.find(s => s.id === stepId);
      const el = document.getElementById(`timeline-${stepId}`);
      if (el && step) {
        el.className = `pipeline-step ${state}`;
        el.textContent = `${icons[state]} ${step.label}`;
      }
    }

    // === Project View ===
    async function renderProject(id) {
      const container = document.getElementById('screen-project');
      let project;
      try {
        const resp = await fetch(`/api/projects/${id}`);
        if (resp.ok) project = await resp.json();
      } catch {}

      if (!project) {
        container.innerHTML = `
          <div style="text-align:center; padding:80px 20px;">
            <h2 style="color:#f85149; margin-bottom:16px;">Проект не найден</h2>
            <p style="color:#8b949e; margin-bottom:20px;">Проект с этим ID не существует или был удалён.</p>
            <button onclick="location.hash='#/'">Вернуться к проектам</button>
          </div>
        `;
        return;
      }

      currentProjectId = project.id;
      const nicheGeo = project.geo ? `${escHtml(project.niche)} в ${escHtml(project.geo)}` : escHtml(project.niche);

      container.innerHTML = `
        <div class="project-header">
          <h1>${nicheGeo}</h1>
          <div class="project-header-meta">
            <span class="pc-status ${project.status}">${STATUS_LABELS[project.status] || project.status}</span>
            ${project.query_lang ? `<span>·</span><span>Запросы: ${escHtml(project.query_lang)}</span>` : ''}
            ${project.site_lang ? `<span>·</span><span>Сайт: ${escHtml(project.site_lang)}</span>` : ''}
            ${project.geo_request ? `<span>·</span><span>Гео запроса: ${escHtml(project.geo_request)}</span>` : ''}
            ${project.injection_name ? `<span>·</span><span>Инъекция: ${escHtml(project.injection_name)}</span>` : ''}
          </div>
        </div>

        <div class="pipeline-timeline" id="pipeline-timeline">
          ${renderTimeline(project.meta?.currentStep, project.status)}
        </div>

        <div id="project-resume-bar"></div>

        <div class="project-pipeline-results" id="pipeline-results">
          <div class="results" id="results"></div>

          <div id="grok-section" style="display:none; margin-top: 24px;">
            <div class="result-card" id="grok-card">
              <div class="result-header">
                <span class="model-badge" style="background:#ef4444;">Grok</span>
                <span class="model-name">Дедупликация критериев</span>
              </div>
              <div class="chat-messages" id="grok-messages"></div>
            </div>
          </div>

          <div id="audience-section" style="display:none; margin-top: 24px;">
            <div class="result-card" id="audience-card">
              <div class="result-header">
                <span class="model-badge" style="background:#ef4444;">Grok</span>
                <span class="model-name">Аудитории и боли ЦА</span>
              </div>
              <div class="chat-messages" id="audience-messages"></div>
            </div>
          </div>

          <div id="design-section" style="display:none; margin-top: 24px;">
            <div class="result-card">
              <div class="result-header">
                <span class="model-badge" style="background:#8b5cf6;">BM25</span>
                <span class="model-name">Дизайн-система под нишу</span>
              </div>
              <div class="chat-messages" id="design-messages" style="max-height:none;"></div>
            </div>
          </div>

          <div id="compiler-section" style="display:none; margin-top: 24px;">
            <div class="result-card" id="compiler-card">
              <div class="result-header">
                <span class="model-badge badge-claude">Claude</span>
                <span class="model-name">XML-структура критериев</span>
              </div>
              <div class="chat-messages" id="compiler-messages" style="max-height:none;"></div>
            </div>
          </div>

          <div id="canvas-section" style="display:none; margin-top: 24px;">
            <div class="result-card" id="canvas-card">
              <div class="result-header">
                <span class="model-badge badge-claude">Claude</span>
                <span class="model-name">Готовый сайт (HTML)</span>
              </div>
              <div class="canvas-toolbar" id="canvas-toolbar" style="display:none;">
                <div class="canvas-tabs">
                  <button class="canvas-tab active" onclick="switchCanvasTab('preview')">Превью</button>
                  <button class="canvas-tab" onclick="switchCanvasTab('code')">Код</button>
                </div>
                <button class="copy-btn" onclick="navigator.clipboard.writeText(canvasRawHtml).then(()=>{this.textContent='Скопировано!';setTimeout(()=>this.textContent='Копировать HTML',1500)})">Копировать HTML</button>
              </div>
              <div class="editor-toolbar" id="editor-toolbar" style="display:none;">
                <div style="flex:1;"></div>
                <button class="editor-btn" id="seo-panel-toggle" onclick="toggleSeoPanel()">SEO и счётчики</button>
                <button class="editor-btn editor-btn-primary" onclick="openInEditor()">Открыть в редакторе</button>
                <button class="editor-btn editor-btn-primary" id="download-html-btn" onclick="downloadHtml()">Скачать HTML</button>
              </div>
              <div id="canvas-loading" class="loading" style="display:none;"><div class="spinner"></div>Claude генерирует сайт...</div>
              <div id="canvas-preview" style="display:none;">
                <iframe id="canvas-iframe" class="canvas-frame" sandbox="allow-scripts allow-same-origin"></iframe>
              </div>
              <div id="canvas-code-view" style="display:none;">
                <pre class="canvas-code"><code id="canvas-code-content"></code></pre>
              </div>
            </div>

            <div class="seo-panel" id="seo-panel">
              <h3>SEO и счётчики</h3>
              <div class="seo-grid">
                <div class="seo-field">
                  <label for="counterYandex">Яндекс.Метрика</label>
                  <textarea id="counterYandex" placeholder="Вставьте полный код счётчика"></textarea>
                </div>
                <div class="seo-field">
                  <label for="counterGoogle">Google Analytics / GTM</label>
                  <textarea id="counterGoogle" placeholder="Вставьте код GA или GTM"></textarea>
                </div>
                <div class="seo-field">
                  <label for="metaYandex">Яндекс.Вебмастер</label>
                  <input type="text" id="metaYandex" placeholder="yandex-verification значение">
                </div>
                <div class="seo-field">
                  <label for="metaGoogle">Google Search Console</label>
                  <input type="text" id="metaGoogle" placeholder="google-site-verification значение">
                </div>
                <div class="seo-field">
                  <label for="metaTitle">Title</label>
                  <input type="text" id="metaTitle" placeholder="Заголовок страницы">
                </div>
                <div class="seo-field">
                  <label for="metaDesc">Description</label>
                  <textarea id="metaDesc" placeholder="Описание страницы (до 160 символов)"></textarea>
                </div>
                <div class="seo-field">
                  <label for="metaKeywords">Keywords</label>
                  <input type="text" id="metaKeywords" placeholder="Ключевые слова через запятую">
                </div>
                <div class="seo-field">
                  <label for="metaOgImage">OG Image URL</label>
                  <input type="text" id="metaOgImage" placeholder="https://example.com/image.jpg">
                </div>
              </div>
              <div class="seo-actions">
                <button class="editor-btn editor-btn-primary" onclick="applySeoCounters()">Применить</button>
              </div>
            </div>
          </div>

          <div id="ratings-section" style="display:none; margin-top: 24px;">
            <div class="result-card" id="ratings-card">
              <div class="result-header">
                <span class="model-badge" style="background:#20b2aa;">Perplexity</span>
                <span class="model-name">Поиск рейтинговых сайтов</span>
              </div>
              <div style="padding: 20px;">
                <div id="ratings-loading" class="loading" style="display:none;"><div class="spinner"></div>Perplexity ищет рейтинги...</div>
                <div class="download-progress" id="ratings-progress"></div>
                <div class="companies-grid" id="ratings-grid"></div>
                <div id="rating-preview-wrap" style="display:none; margin-top: 16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span id="rating-preview-title" style="font-size:14px; color:#58a6ff; font-weight:600;"></span>
                    <button class="copy-btn" onclick="document.getElementById('rating-preview-wrap').style.display='none'">Закрыть</button>
                  </div>
                  <iframe id="rating-preview-iframe" class="company-preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
                </div>
              </div>
            </div>
          </div>

          <div id="fill-section" style="display:none; margin-top: 24px;">
            <div class="result-card">
              <div class="result-header">
                <span class="model-badge" style="background:#f0883e;">Claude</span>
                <span class="model-name">Наполнение контентом</span>
              </div>
              <div style="padding: 20px;">
                <div id="fill-loading" class="loading" style="display:none;">
                  <div class="spinner"></div>Claude наполняет сайт реальными данными...
                </div>
                <div id="fill-messages" class="chat-messages" style="max-height:none;"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="project-actions" style="margin-top:24px;">
          <button onclick="duplicateProject('${project.id}'); location.hash='#/';">Дублировать</button>
          <button onclick="deleteProject('${project.id}')" style="color:#f85149;">Удалить</button>
        </div>

        <details class="project-meta-section">
          <summary>Метаданные проекта ▾</summary>
          <div class="project-meta-content">
            <pre style="white-space:pre-wrap; word-break:break-all; font-size:12px; color:#8b949e;">ID: ${project.id}
Ниша: ${project.niche}
Гео: ${project.geo || '—'}
Язык запросов: ${project.query_lang || 'Русский'}
Язык сайта: ${project.site_lang || 'Русский'}
Статус: ${project.status} | Пайплайн: ${project.pipelineStatus || 'idle'}
Шаг пайплайна: ${project.meta?.currentStep || '—'}
Компания: ${project.injection_name || '—'}</pre>
          </div>
        </details>
      `;

      // Restore state from project meta and render existing results
      await restoreProjectState(project);

      // Auto-connect SSE if pipeline is running
      if (project.pipelineStatus === 'running') {
        pipelineRunning = true;
        connectPipelineSSE(project.id);
      } else if (project.pipelineStatus === 'idle' && project.currentStep) {
        // Show resume button
        const stepLabels = Object.fromEntries(PIPELINE_STEPS.map(s => [s.id, s.label]));
        const resumeBar = document.getElementById('project-resume-bar');
        resumeBar.innerHTML = `
          <div class="project-resume-bar">
            <span style="flex:1;">Пайплайн остановлен на шаге: <strong>${stepLabels[project.currentStep] || project.currentStep}</strong></span>
            <button onclick="runPipeline('${project.id}', '${getNextStep(project.currentStep)}')" style="background:#238636; border-color:#238636; color:#fff;">Продолжить</button>
            <button onclick="runPipeline('${project.id}')" style="background:#1f6feb; border-color:#1f6feb; color:#fff;">Перезапустить</button>
          </div>
        `;
      } else if (project.status === 'new' && !project.currentStep) {
        // New project — auto-start
        setTimeout(() => runPipeline(project.id), 100);
      }
    }

    function getNextStep(currentStep) {
      const stepOrder = PIPELINE_STEPS.map(s => s.id);
      const idx = stepOrder.indexOf(currentStep);
      if (idx < 0 || idx >= stepOrder.length - 1) return null;
      return stepOrder[idx + 1];
    }

    async function restoreProjectState(project) {
      const meta = project.meta || {};

      // Restore global vars from meta
      if (meta.conversations) Object.assign(conversations, meta.conversations);
      if (meta.compilerRawXml) compilerRawXml = meta.compilerRawXml;

      // Restore step results using the same rendering as SSE
      if (meta.conversations) {
        renderStepResult('step_1_2', { conversations: meta.conversations });
      }
      if (meta.grokCriteriaRaw) {
        const s = document.getElementById('grok-section');
        if (s) s.style.display = 'block';
        renderStepResult('step_3', { grokCriteriaRaw: meta.grokCriteriaRaw });
      }
      if (meta.grokAudienceRaw) {
        const s = document.getElementById('audience-section');
        if (s) s.style.display = 'block';
        renderStepResult('step_4', { grokAudienceRaw: meta.grokAudienceRaw });
      }
      if (meta.designSystemRaw) {
        const s = document.getElementById('design-section');
        if (s) s.style.display = 'block';
        renderStepResult('step_design', { designSystemRaw: meta.designSystemRaw });
      }
      if (meta.compilerRawXml) {
        const s = document.getElementById('compiler-section');
        if (s) s.style.display = 'block';
        renderStepResult('step_5', { compilerRawXml: meta.compilerRawXml });
      }
      if (meta.extractedRatings) {
        extractedRatings = meta.extractedRatings;
        if (meta.downloadedRatings) downloadedRatings = meta.downloadedRatings;
        const s = document.getElementById('ratings-section');
        if (s && extractedRatings.length > 0) {
          s.style.display = 'block';
          renderRatingsGrid();
        }
      }

      // Restore HTML preview from server
      try {
        const htmlResp = await fetch(`/api/projects/${project.id}/html`);
        if (htmlResp.ok) {
          canvasRawHtml = await htmlResp.text();
          if (canvasRawHtml) {
            const canvasSection = document.getElementById('canvas-section');
            if (canvasSection) {
              canvasSection.style.display = 'block';
              document.getElementById('canvas-toolbar').style.display = 'flex';
              document.getElementById('editor-toolbar').style.display = 'flex';
              document.getElementById('canvas-preview').style.display = 'block';
              const iframe = document.getElementById('canvas-iframe');
              if (iframe) setTimeout(() => { iframe.srcdoc = canvasRawHtml; }, 0);
              const codeContent = document.getElementById('canvas-code-content');
              if (codeContent) codeContent.textContent = canvasRawHtml;
            }

            if (project.status === 'filled') {
              const fillSection = document.getElementById('fill-section');
              if (fillSection) {
                fillSection.style.display = '';
                const fillMessages = document.getElementById('fill-messages');
                if (fillMessages) fillMessages.innerHTML = `
                  <div class="chat-msg chat-msg-assistant" style="padding:12px">
                    <div style="font-size:12px; color:#7ee787;">Сайт наполнен реальными данными компаний</div>
                  </div>`;
              }
            }
          }
        }
      } catch {}

      // Restore SEO fields
      if (project.seo_block) {
        try {
          const seoData = JSON.parse(project.seo_block);
          ['counterYandex','counterGoogle','metaYandex','metaGoogle','metaTitle','metaDesc','metaKeywords','metaOgImage'].forEach(f => {
            const el = document.getElementById(f);
            if (el && seoData[f]) el.value = seoData[f];
          });
        } catch(e) {}
      }
    }

    // === Start Project (from generator form) ===
    async function startProject() {
      const apiKey = document.getElementById("apiKey").value.trim();
      const niche = document.getElementById("niche").value.trim();
      if (!apiKey) return alert("Введите API-ключ OpenRouter");
      if (!niche) return alert("Введите название ниши");
      localStorage.setItem("openrouter_key", apiKey);
      const projectId = await createProject();
      if (projectId) location.hash = '#/project/' + projectId;
    }

    // Project view actions
    async function projectOpenInEditor(id) {
      const resp = await fetch(`/api/projects/${id}/html`);
      if (!resp.ok) return showNotification('Нет HTML для редактирования', true);
      canvasRawHtml = await resp.text();
      currentProjectId = id;
      openInEditor();
    }

    async function projectDownloadHtml(id) {
      const resp = await fetch(`/api/projects/${id}/html`);
      if (!resp.ok) return showNotification('Нет HTML для скачивания', true);
      const html = await resp.text();

      const dateStr = new Date().toISOString().slice(0, 10);
      const filename = `rating-${dateStr}.html`;
      const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }


    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    async function createProject() {
      const niche = document.getElementById('niche').value.trim();
      const geo = document.getElementById('geo').value.trim() || '';
      const geoRequest = document.getElementById('geoRequest').value.trim() || '';
      const queryLang = document.getElementById('queryLang').value;
      const siteLang = document.getElementById('siteLang').value;
      const userCompanyData = document.getElementById('user-company-data')?.value.trim() || '';
      const designStyle = document.getElementById('designStyle')?.value || 'auto';

      let injectionName = '', injectionInfo = '';
      if (userCompanyData) {
        injectionInfo = userCompanyData;
        const lines = userCompanyData.split('\n');
        if (lines[0]) injectionName = lines[0].trim();
      }

      try {
        const resp = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            niche, geo, geo_request: geoRequest,
            query_lang: queryLang, site_lang: siteLang,
            injection_name: injectionName, injection_info: injectionInfo,
            design_style: designStyle,
          }),
        });
        if (!resp.ok) {
          const errText = await resp.text();
          showNotification(`Ошибка создания проекта (${resp.status}): ${errText.substring(0, 200)}`, true);
          return null;
        }
        const project = await resp.json();
        currentProjectId = project.id;
        return project.id;
      } catch (err) {
        showNotification('Ошибка создания проекта: ' + err.message, true);
        console.error('createProject error:', err, 'URL:', window.location.href);
        return null;
      }
    }

    // updateProjectMeta — server handles this during pipeline
    function updateProjectMeta() {}

    async function updateProjectStatus(status) {
      if (!currentProjectId) return;
      await fetch(`/api/projects/${currentProjectId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });
    }

    async function updateProjectHtml(htmlContent) {
      if (!currentProjectId || !htmlContent) return;
      await fetch(`/api/projects/${currentProjectId}/html`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ html: htmlContent }),
      });
    }

    function openProject(id) {
      location.hash = '#/project/' + id;
    }

    async function duplicateProject(id) {
      try {
        await fetch(`/api/projects/${id}/duplicate`, { method: 'POST' });
        const hash = location.hash || '#/';
        if (hash === '#/' || hash === '#') renderDashboard();
        showNotification('Проект дублирован');
      } catch (err) {
        showNotification('Ошибка: ' + err.message, true);
      }
    }

    async function deleteProject(id) {
      if (!confirm('Удалить проект? Это действие необратимо.')) return;

      try {
        await fetch(`/api/projects/${id}`, { method: 'DELETE' });
        if (currentProjectId === id) currentProjectId = null;
        const hash = location.hash || '#/';
        if (hash === '#/' || hash === '#') renderDashboard();
        if (hash === `#/project/${id}`) location.hash = '#/';
        showNotification('Проект удалён');
      } catch (err) {
        showNotification('Ошибка: ' + err.message, true);
      }
    }

    const MODELS = [
      { id: "openai/gpt-5", name: "ChatGPT (GPT-5)" },
      { id: "google/gemini-3-pro-preview", name: "Gemini 3 Pro" },
      { id: "anthropic/claude-sonnet-4.5", name: "Claude (Sonnet 4.5)" },
    ];

    // Conversation history per model (for interactive chat, populated from SSE)
    const conversations = {};

    // Retry wrapper + callModel kept for interactive chat from UI
    async function withRetry(fn, { retries = 3, baseDelay = 2000, label = '' } = {}) {
      for (let attempt = 0; attempt <= retries; attempt++) {
        try {
          return await fn();
        } catch (err) {
          const isNetworkError = err.name === 'TypeError' || err.message?.includes('Failed to fetch') || err.message?.includes('NetworkError') || err.message?.includes('network');
          if (!isNetworkError || attempt === retries) throw err;
          const delay = baseDelay * Math.pow(2, attempt);
          console.warn(`[retry] ${label || 'request'} failed (attempt ${attempt + 1}/${retries}), retrying in ${delay}ms:`, err.message);
          await new Promise(r => setTimeout(r, delay));
        }
      }
    }

    async function callModel(modelId, messages, apiKey) {
      return withRetry(async () => {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ model: modelId, messages }),
        });

        if (!response.ok) {
          const err = await response.text();
          return { error: `Ошибка API: ${response.status} — ${err}` };
        }

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || "Пустой ответ";
        return { content };
      }, { retries: 3, baseDelay: 2000, label: modelId });
    }

    function mdTableToHtml(text) {
      const lines = text.split("\n").map(l => l.trim()).filter(l => l.startsWith("|"));
      if (lines.length < 2) return null;

      const parseRow = line => line.split("|").slice(1, -1).map(c => c.trim());

      const headers = parseRow(lines[0]);
      // skip separator line (line with ---)
      const startIdx = lines[1].includes("---") ? 2 : 1;
      const rows = lines.slice(startIdx).map(parseRow);

      let html = "<table><thead><tr>";
      for (const h of headers) html += `<th>${h}</th>`;
      html += "</tr></thead><tbody>";
      for (const row of rows) {
        html += "<tr>";
        for (const cell of row) html += `<td>${cell}</td>`;
        html += "</tr>";
      }
      html += "</tbody></table>";
      return html;
    }

    // Parse audience response: always produce 2-column table + portraits block
    function parseAudienceResponse(text) {
      const lines = text.split("\n").map(l => l.trim()).filter(l => l.startsWith("|"));
      if (lines.length < 3) return null;

      const parseRow = line => line.split("|").slice(1, -1).map(c => c.trim());
      const headers = parseRow(lines[0]);
      const startIdx = lines[1].includes("---") ? 2 : 1;
      const dataRows = lines.slice(startIdx).map(parseRow);

      const colCount = headers.length;

      // Determine which columns are ЦА and Боль/Интент
      // If 3+ columns: first = ЦА, last = Боль, middle = Портрет
      const caIdx = 0;
      const painIdx = colCount - 1;
      const portraitIdx = colCount >= 3 ? 1 : -1;

      // Build 2-column table
      let tableHtml = `<table><thead><tr><th>ЦА</th><th>Боль / Интент</th></tr></thead><tbody>`;
      const portraits = {};

      for (const row of dataRows) {
        const ca = row[caIdx] || "";
        const pain = row[painIdx] || "";
        tableHtml += `<tr><td>${ca}</td><td>${pain}</td></tr>`;

        // Collect unique portraits
        if (portraitIdx >= 0 && row[portraitIdx] && ca && !portraits[ca]) {
          portraits[ca] = row[portraitIdx];
        }
      }
      tableHtml += "</tbody></table>";

      // Build portraits HTML
      let portraitsHtml = "";
      const entries = Object.entries(portraits);
      if (entries.length > 0) {
        portraitsHtml = `<div style="margin-top:20px; padding-top:16px; border-top:1px solid #30363d;">
          <div style="font-size:12px; color:#58a6ff; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:12px;">Портреты ЦА</div>`;
        for (const [name, desc] of entries) {
          portraitsHtml += `<div style="margin-bottom:8px; font-size:14px; line-height:1.6;"><span style="color:#e1e4e8; font-weight:600;">${name}:</span> <span style="color:#8b949e;">${desc}</span></div>`;
        }
        portraitsHtml += "</div>";
      }

      return { tableHtml, portraitsHtml };
    }

    // XML syntax highlighter
    function highlightXml(text) {
      // Strip markdown code fences if present
      text = text.replace(/^```xml\s*\n?/i, '').replace(/\n?```\s*$/i, '').trim();
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/&lt;(\/?[\w_]+)(.*?)&gt;/g, (match, tag, rest) => {
          // Highlight attributes inside tags
          const highlighted = rest.replace(/([\w_]+)=(&quot;|")(.*?)(&quot;|")/g,
            '<span class="xml-attr">$1</span>=<span class="xml-val">"$3"</span>');
          return `<span class="xml-tag">&lt;${tag}${highlighted}&gt;</span>`;
        });
    }

    let compilerRawXml = ""; // Store for copy button
    let canvasRawHtml = ""; // Store for copy button
    let extractedRatings = [];   // [{name, url, status, errorReason}]
    let downloadedRatings = {};  // {name: {html, text}}

    // Render ratings grid
    function renderRatingsGrid() {
      const grid = document.getElementById('ratings-grid');
      if (!grid) return;

      const doneCount = extractedRatings.filter(c => c.status === 'done').length;
      const totalCount = extractedRatings.length;
      const errorCount = extractedRatings.filter(c => c.status === 'error').length;

      document.getElementById('ratings-progress').textContent =
        `Загружено рейтингов: ${doneCount} из ${totalCount}` + (errorCount > 0 ? ` (ошибок: ${errorCount})` : '');

      grid.innerHTML = extractedRatings.map((rating, idx) => {
        const tooltip = rating.status === 'error'
          ? `Ошибка: ${rating.errorReason || 'неизвестна'}\nURL: ${rating.url || '—'}`
          : (rating.url || 'URL не найден');
        return `
        <button class="company-btn status-${rating.status}"
                onclick="previewRatingSite(${idx})"
                title="${tooltip}">
          <span class="company-status-icon ${rating.status}"></span>
          <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${rating.name}</span>
          ${rating.status === 'loading' ? '<span class="spinner-small"></span>' : ''}
        </button>`;
      }).join('');
    }

    // Preview a downloaded rating site in iframe (or show error details)
    function previewRatingSite(idx) {
      const rating = extractedRatings[idx];
      if (!rating) return;

      if (rating.status === 'error') {
        alert(`Ошибка загрузки: ${rating.name}\nURL: ${rating.url || '—'}\nПричина: ${rating.errorReason || 'неизвестна'}`);
        return;
      }
      if (rating.status !== 'done') return;

      const wrap = document.getElementById('rating-preview-wrap');
      const iframe = document.getElementById('rating-preview-iframe');
      const title = document.getElementById('rating-preview-title');

      title.textContent = `${rating.name} — ${rating.url}`;
      iframe.srcdoc = downloadedRatings[rating.name]?.html || '<p>Нет данных</p>';
      wrap.style.display = 'block';
      wrap.scrollIntoView({ behavior: 'smooth' });
    }




    function switchCanvasTab(tab) {
      const previewEl = document.getElementById('canvas-preview');
      const codeEl = document.getElementById('canvas-code-view');
      const tabs = document.querySelectorAll('.canvas-tab');
      tabs.forEach(t => t.classList.remove('active'));
      if (tab === 'preview') {
        previewEl.style.display = 'block';
        codeEl.style.display = 'none';
        tabs[0].classList.add('active');
      } else {
        previewEl.style.display = 'none';
        codeEl.style.display = 'block';
        tabs[1].classList.add('active');
      }
    }

    // =============================================
    // Block Editor — state
    // =============================================
    let editorActive = false;
    let historyStack = [];
    let historyIndex = -1;
    const MAX_HISTORY = 20;
    let editorInjected = false;

    // =============================================
    // 3C — SEO Panel toggle & apply
    // =============================================
    function toggleSeoPanel() {
      const panel = document.getElementById('seo-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function showNotification(text, isError) {
      const div = document.createElement('div');
      div.className = 'seo-notification';
      if (isError) div.style.background = '#da3633';
      div.textContent = text;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 2600);
    }

    function applySeoCounters() {
      const iframe = document.getElementById('canvas-iframe');
      const iDoc = iframe.contentDocument;
      if (!iDoc) return showNotification('Сначала сгенерируйте сайт', true);

      const metaTitle = document.getElementById('metaTitle').value.trim();
      const metaDesc = document.getElementById('metaDesc').value.trim();
      const metaKeywords = document.getElementById('metaKeywords').value.trim();
      const metaYandex = document.getElementById('metaYandex').value.trim();
      const metaGoogle = document.getElementById('metaGoogle').value.trim();
      const metaOgImage = document.getElementById('metaOgImage').value.trim();
      const counterYandex = document.getElementById('counterYandex').value.trim();
      const counterGoogle = document.getElementById('counterGoogle').value.trim();

      const head = iDoc.head;

      // --- SEO block ---
      let seoContent = '';
      if (metaTitle) seoContent += `<title>${metaTitle}</title>\n`;
      if (metaDesc) seoContent += `<meta name="description" content="${metaDesc}">\n`;
      if (metaKeywords) seoContent += `<meta name="keywords" content="${metaKeywords}">\n`;
      if (metaYandex) seoContent += `<meta name="yandex-verification" content="${metaYandex}">\n`;
      if (metaGoogle) seoContent += `<meta name="google-site-verification" content="${metaGoogle}">\n`;
      if (metaTitle) seoContent += `<meta property="og:title" content="${metaTitle}">\n`;
      if (metaDesc) seoContent += `<meta property="og:description" content="${metaDesc}">\n`;
      if (metaOgImage) seoContent += `<meta property="og:image" content="${metaOgImage}">\n`;
      seoContent += `<meta property="og:type" content="website">\n`;

      // --- Counters block ---
      let countersContent = '';
      if (counterYandex) countersContent += counterYandex + '\n';
      if (counterGoogle) countersContent += counterGoogle + '\n';

      // Update head innerHTML via string manipulation for reliability
      let headHtml = head.innerHTML;

      // Replace or insert SEO block
      const seoRe = /<!-- PROTECTED:SEO:START -->[\s\S]*?<!-- PROTECTED:SEO:END -->/;
      const seoBlock = `<!-- PROTECTED:SEO:START -->\n${seoContent}<!-- PROTECTED:SEO:END -->`;
      if (seoRe.test(headHtml)) {
        headHtml = headHtml.replace(seoRe, seoBlock);
      } else {
        headHtml += '\n' + seoBlock;
      }

      // Replace or insert Counters block
      const cntRe = /<!-- PROTECTED:COUNTERS:START -->[\s\S]*?<!-- PROTECTED:COUNTERS:END -->/;
      const cntBlock = `<!-- PROTECTED:COUNTERS:START -->\n${countersContent}<!-- PROTECTED:COUNTERS:END -->`;
      if (cntRe.test(headHtml)) {
        headHtml = headHtml.replace(cntRe, cntBlock);
      } else {
        headHtml += '\n' + cntBlock;
      }

      head.innerHTML = headHtml;
      syncCanvasRawHtml();

      // Save SEO data to project via API
      const seoData = {};
      ['counterYandex','counterGoogle','metaYandex','metaGoogle','metaTitle','metaDesc','metaKeywords','metaOgImage'].forEach(f => {
        const el = document.getElementById(f);
        if (el) seoData[f] = el.value;
      });
      if (currentProjectId) {
        fetch(`/api/projects/${currentProjectId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ seo_block: JSON.stringify(seoData) }),
        }).catch(() => {});
      }

      showNotification('Счётчики и мета-теги применены');
    }

    // =============================================
    // 3B.6 — Autosave canvasRawHtml from iframe
    // =============================================
    function getActiveEditorDoc() {
      // If editor window is open, prefer it
      if (editorWindow && !editorWindow.closed && editorWindow.document?.body) {
        return editorWindow.document;
      }
      const iframe = document.getElementById('canvas-iframe');
      return iframe?.contentDocument || null;
    }

    function syncCanvasRawHtml() {
      if (editorWindow && !editorWindow.closed) {
        // Sync from editor window — get clean HTML without editor artifacts
        const doc = editorWindow.document;
        if (doc?.documentElement) {
          let html = '<!DOCTYPE html>' + doc.documentElement.outerHTML;
          // Clean editor artifacts
          html = html.replace(/<div id="__ew_toolbar__">[\s\S]*?<\/div>\s*/, '');
          html = html.replace(/<style id="__editor_style__">[\s\S]*?<\/style>/g, '');
          html = html.replace(/<style id="__editor_spin_style__">[\s\S]*?<\/style>/g, '');
          html = html.replace(/<style id="__ew_anim_style__">[\s\S]*?<\/style>/g, '');
          html = html.replace(/<div class="__editor_toolbar__">[\s\S]*?<\/div>/g, '');
          html = html.replace(/<div class="__editor_comment_popup__">[\s\S]*?<\/div>/g, '');
          html = html.replace(/<div class="__editor_loader__">[\s\S]*?<\/div>/g, '');
          html = html.replace(/<div id="__ew_seo_panel__">[\s\S]*?<\/div>\s*<\/div>/g, '');
          html = html.replace(/<div id="__ew_notification__">[\s\S]*?<\/div>/g, '');
          html = html.replace(/ ?class="__editor_hover__"/g, '');
          html = html.replace(/ ?class="__editor_collapsed__"/g, '');
          html = html.replace(/ style="position: relative;"/g, '');
          html = html.replace(/ style="padding-top: 50px;"/g, '');
          canvasRawHtml = html;
          editorWindowDirty = true;
        }
      } else {
        const iframe = document.getElementById('canvas-iframe');
        if (iframe?.contentDocument?.documentElement) {
          canvasRawHtml = '<!DOCTYPE html>' + iframe.contentDocument.documentElement.outerHTML;
        }
      }
      // Also update code view
      const codeContent = document.getElementById("canvas-code-content");
      if (codeContent) codeContent.textContent = canvasRawHtml;
      updateProjectHtml(canvasRawHtml);
    }

    // =============================================
    // 3B.5 — Undo / Redo
    // =============================================
    function pushSnapshot() {
      const doc = getActiveEditorDoc();
      const body = doc?.body;
      if (!body) return;

      // If we're in the middle of history, discard the forward part
      if (historyIndex < historyStack.length - 1) {
        historyStack = historyStack.slice(0, historyIndex + 1);
      }

      historyStack.push(body.innerHTML);

      if (historyStack.length > MAX_HISTORY) {
        historyStack.shift();
      }
      historyIndex = historyStack.length - 1;
      updateUndoRedoButtons();
    }

    function editorUndo() {
      if (historyIndex <= 0) return;
      historyIndex--;
      restoreSnapshot();
    }

    function editorRedo() {
      if (historyIndex >= historyStack.length - 1) return;
      historyIndex++;
      restoreSnapshot();
    }

    function restoreSnapshot() {
      const doc = getActiveEditorDoc();
      const body = doc?.body;
      if (!body || historyIndex < 0 || historyIndex >= historyStack.length) return;

      body.innerHTML = historyStack[historyIndex];
      // Restore padding-top if in editor window
      if (editorWindow && !editorWindow.closed && doc === editorWindow.document) {
        body.style.paddingTop = '50px';
      }
      syncCanvasRawHtml();
      updateUndoRedoButtons();
      // Re-inject editor event listeners after restoring
      if (editorActive) injectEditorListeners(doc);
    }

    function updateUndoRedoButtons() {
      document.getElementById('undo-btn').disabled = historyIndex <= 0;
      document.getElementById('redo-btn').disabled = historyIndex >= historyStack.length - 1;
    }

    // =============================================
    // 3B.1 — Editor mode toggle
    // =============================================
    function toggleEditorMode(on) {
      editorActive = on;
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');

      undoBtn.style.display = on ? '' : 'none';
      redoBtn.style.display = on ? '' : 'none';

      const iDoc = getActiveEditorDoc();
      if (!iDoc) return;

      if (on) {
        // Take initial snapshot
        if (historyStack.length === 0) pushSnapshot();
        injectEditorListeners(iDoc);
      } else {
        removeEditorOverlays(iDoc);
      }
    }

    // =============================================
    // 3B.2 — Hover overlay + toolbar injection
    // =============================================
    function injectEditorListeners(iDoc) {
      // Remove previous injected style/listeners if any
      removeEditorOverlays(iDoc);

      // Inject overlay style
      const style = iDoc.createElement('style');
      style.id = '__editor_style__';
      style.textContent = `
        [data-block-id].__editor_hover__ {
          outline: 2px dashed #3b82f6 !important;
          outline-offset: 4px !important;
          position: relative;
        }
        .__editor_toolbar__ {
          position: absolute;
          top: 4px;
          right: 4px;
          z-index: 9999;
          display: flex;
          gap: 4px;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 12px rgba(0,0,0,0.18);
          padding: 4px 6px;
          font-size: 13px;
        }
        .__editor_toolbar__ button {
          background: #f3f4f6;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          padding: 4px 8px;
          cursor: pointer;
          font-size: 13px;
          line-height: 1;
        }
        .__editor_toolbar__ button:hover {
          background: #e5e7eb;
        }
        .__editor_comment_popup__ {
          position: absolute;
          top: 40px;
          right: 4px;
          z-index: 10000;
          background: #fff;
          border: 1px solid #d1d5db;
          border-radius: 8px;
          box-shadow: 0 4px 16px rgba(0,0,0,0.2);
          padding: 12px;
          width: 300px;
        }
        .__editor_comment_popup__ textarea {
          width: 100%;
          min-height: 80px;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          padding: 8px;
          font-size: 13px;
          resize: vertical;
          margin-bottom: 8px;
        }
        .__editor_comment_popup__ button {
          background: #3b82f6;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 6px 16px;
          cursor: pointer;
          font-size: 13px;
        }
        .__editor_loader__ {
          position: absolute;
          inset: 0;
          background: rgba(255,255,255,0.85);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9998;
          font-size: 14px;
          color: #333;
          border-radius: inherit;
        }
        .__editor_collapsed__ > *:not(.__editor_toolbar__) {
          display: none !important;
        }
      `;
      iDoc.head.appendChild(style);

      let hoverTimeout = null;
      let currentToolbar = null;

      const onMouseOver = (e) => {
        const block = e.target.closest('[data-block-id]');
        if (!block) return;

        clearTimeout(hoverTimeout);
        block.classList.add('__editor_hover__');

        if (currentToolbar && currentToolbar.parentElement !== block) {
          currentToolbar.remove();
          currentToolbar = null;
        }
        if (!currentToolbar) {
          currentToolbar = createBlockToolbar(block, iDoc);
          // Ensure the block has position:relative for absolute toolbar
          if (getComputedStyle(block).position === 'static') {
            block.style.position = 'relative';
          }
          block.appendChild(currentToolbar);
        }
      };

      const onMouseOut = (e) => {
        const block = e.target.closest('[data-block-id]');
        if (!block) return;

        hoverTimeout = setTimeout(() => {
          // Check if mouse is still over this block or its toolbar
          const hovered = iDoc.querySelectorAll(':hover');
          for (const el of hovered) {
            if (el === block || block.contains(el)) return;
          }
          block.classList.remove('__editor_hover__');
          if (currentToolbar && currentToolbar.parentElement === block) {
            currentToolbar.remove();
            currentToolbar = null;
          }
        }, 200);
      };

      iDoc.body.addEventListener('mouseover', onMouseOver);
      iDoc.body.addEventListener('mouseout', onMouseOut);

      // Store references for cleanup
      iDoc.body.__editorMouseOver = onMouseOver;
      iDoc.body.__editorMouseOut = onMouseOut;
    }

    function createBlockToolbar(block, iDoc) {
      const toolbar = iDoc.createElement('div');
      toolbar.className = '__editor_toolbar__';

      const blockType = block.getAttribute('data-block-type');
      const isCollapsed = block.classList.contains('__editor_collapsed__');

      // Delete button
      const delBtn = iDoc.createElement('button');
      delBtn.textContent = '🗑';
      delBtn.title = 'Удалить блок';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        pushSnapshot();
        if (blockType === 'company-card' || blockType === 'company-row') {
          block.remove();
          recalcCompanyRanks(iDoc);
        } else {
          block.remove();
        }
        syncCanvasRawHtml();
        const isEditorWin = editorWindow && !editorWindow.closed && iDoc === editorWindow.document;
        if (editorActive || isEditorWin) injectEditorListeners(iDoc);
      };
      toolbar.appendChild(delBtn);

      // Comment button
      const commentBtn = iDoc.createElement('button');
      commentBtn.textContent = '💬';
      commentBtn.title = 'Комментарий к блоку';
      commentBtn.onclick = (e) => {
        e.stopPropagation();
        openCommentPopup(block, iDoc);
      };
      toolbar.appendChild(commentBtn);

      // Collapse/expand button
      const collapseBtn = iDoc.createElement('button');
      collapseBtn.textContent = isCollapsed ? '↕ ▸' : '↕ ▾';
      collapseBtn.title = isCollapsed ? 'Развернуть' : 'Свернуть';
      collapseBtn.onclick = (e) => {
        e.stopPropagation();
        block.classList.toggle('__editor_collapsed__');
        collapseBtn.textContent = block.classList.contains('__editor_collapsed__') ? '↕ ▸' : '↕ ▾';
        collapseBtn.title = block.classList.contains('__editor_collapsed__') ? 'Развернуть' : 'Свернуть';
      };
      toolbar.appendChild(collapseBtn);

      return toolbar;
    }

    // =============================================
    // 3B.3 — Delete company with rank recalc
    // =============================================
    function recalcCompanyRanks(iDoc) {
      const allRanked = Array.from(iDoc.querySelectorAll('[data-company-rank]'));
      // Sort by DOM order (already in order from querySelectorAll)
      allRanked.forEach((el, idx) => {
        const oldRank = el.getAttribute('data-company-rank');
        const newRank = String(idx + 1);
        el.setAttribute('data-company-rank', newRank);

        // Update visual rank number inside the element
        // Look for first element that contains just the old rank number
        const walker = iDoc.createTreeWalker(el, NodeFilter.SHOW_TEXT);
        while (walker.nextNode()) {
          const node = walker.currentNode;
          const trimmed = node.textContent.trim();
          if (trimmed === oldRank || trimmed === '#' + oldRank || trimmed === oldRank + '.') {
            node.textContent = node.textContent.replace(oldRank, newRank);
            break;
          }
        }
      });

      // Update Schema.org JSON-LD ItemList
      const scripts = iDoc.querySelectorAll('script[type="application/ld+json"]');
      scripts.forEach(script => {
        try {
          const json = JSON.parse(script.textContent);
          if (json['@type'] === 'ItemList' && Array.isArray(json.itemListElement)) {
            // Remove items whose name/position no longer exists
            // Re-index positions
            json.itemListElement.forEach((item, idx) => {
              item.position = idx + 1;
            });
            // If items were deleted, we need to reconcile — but we can only re-index
            // The delete already removed the DOM element; ItemList entries won't auto-sync
            // So we just re-number what's left
            script.textContent = JSON.stringify(json, null, 2);
          }
        } catch (e) { /* ignore parse errors */ }
      });
    }

    // =============================================
    // 3B.4 — Block regeneration via comment
    // =============================================
    function openCommentPopup(block, iDoc) {
      // Remove existing popups
      iDoc.querySelectorAll('.__editor_comment_popup__').forEach(p => p.remove());

      const popup = iDoc.createElement('div');
      popup.className = '__editor_comment_popup__';

      const textarea = iDoc.createElement('textarea');
      textarea.placeholder = 'Опишите, что изменить в этом блоке...';
      popup.appendChild(textarea);

      const sendBtn = iDoc.createElement('button');
      sendBtn.textContent = 'Отправить';
      sendBtn.onclick = async () => {
        const userComment = textarea.value.trim();
        if (!userComment) return;
        popup.remove();
        await regenerateBlock(block, userComment, iDoc);
      };
      popup.appendChild(sendBtn);

      const compStyle = (iDoc.defaultView || window).getComputedStyle(block);
      if (compStyle.position === 'static') {
        block.style.position = 'relative';
      }
      block.appendChild(popup);
      textarea.focus();
    }

    // Show notification in the correct document context (editor window or main window)
    function showEditorNotification(iDoc, msg, isError) {
      const targetDoc = iDoc || document;
      const note = targetDoc.createElement('div');
      Object.assign(note.style, {
        position: 'fixed', bottom: '20px', right: '20px', zIndex: '100000',
        background: isError ? '#da3633' : '#238636', color: '#fff',
        padding: '10px 20px', borderRadius: '8px', fontSize: '13px',
        fontFamily: '-apple-system,BlinkMacSystemFont,sans-serif',
        boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
        transition: 'opacity 0.3s'
      });
      note.textContent = msg;
      targetDoc.body.appendChild(note);
      setTimeout(() => { note.style.opacity = '0'; setTimeout(() => note.remove(), 300); }, 2500);
      // Also show in main window for consistency
      if (targetDoc !== document) showNotification(msg, isError);
    }

    async function regenerateBlock(block, userComment, iDoc) {
      // Try multiple sources for API key
      const editorConfig = iDoc.defaultView?.__EDITOR_CONFIG__;
      const apiKey = localStorage.getItem("openrouter_key")
        || editorConfig?.apiKey
        || document.getElementById("apiKey")?.value?.trim()
        || '';
      if (!apiKey) {
        showEditorNotification(iDoc, 'Нет API-ключа OpenRouter', true);
        return;
      }

      // Save snapshot for undo
      pushSnapshot();

      // Show loader on block
      const loader = iDoc.createElement('div');
      loader.className = '__editor_loader__';
      loader.innerHTML = '<div style="text-align:center;"><div style="border:3px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;width:28px;height:28px;animation:spin 0.8s linear infinite;margin:0 auto 8px;"></div>Регенерация...</div>';
      // Add spin keyframes if not present
      if (!iDoc.getElementById('__editor_spin_style__')) {
        const spinStyle = iDoc.createElement('style');
        spinStyle.id = '__editor_spin_style__';
        spinStyle.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
        iDoc.head.appendChild(spinStyle);
      }
      const compStyle = (iDoc.defaultView || window).getComputedStyle(block);
      if (compStyle.position === 'static') {
        block.style.position = 'relative';
      }
      block.appendChild(loader);

      // Collect context — minimal CSS for speed
      const blockHtml = block.outerHTML;
      const siteLang = editorConfig?.siteLang || document.getElementById('siteLang')?.value || 'Русский';

      // Extract only :root vars and classes used in the block
      const allStyles = Array.from(iDoc.querySelectorAll('style:not([id^="__editor"])')).map(s => s.textContent).join('\n');
      const rootMatch = allStyles.match(/:root\s*\{[^}]*\}/g);
      const rootVars = rootMatch ? rootMatch.join('\n') : '';
      // Find class names used in block HTML
      const classNames = new Set();
      (blockHtml.match(/class="([^"]*)"/g) || []).forEach(m => {
        m.replace(/class="([^"]*)"/, '$1').split(/\s+/).forEach(c => { if (c && !c.startsWith('__editor')) classNames.add(c); });
      });
      // Extract only matching CSS rules (up to 4000 chars)
      let relevantCSS = rootVars + '\n';
      if (classNames.size > 0) {
        // No 'g' flag — test() with 'g' skips every other match due to lastIndex
        const classPattern = new RegExp('\\.' + [...classNames].map(c => c.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|\\.'));
        const rules = allStyles.match(/[^{}]*\{[^}]*\}/g) || [];
        for (const rule of rules) {
          if (classPattern.test(rule)) {
            relevantCSS += rule + '\n';
            if (relevantCSS.length > 4000) break;
          }
        }
      }

      const regenPrompt = `РОЛЬ: Ты — фронтенд-разработчик. Перерисуй HTML-блок по инструкции пользователя.

ЯЗЫК КОНТЕНТА: ${siteLang}

СТИЛЕВОЙ КОНТЕКСТ (CSS-переменные и классы блока):
<site_styles>
${relevantCSS}
</site_styles>

ТЕКУЩИЙ HTML БЛОКА:
<current_block>
${blockHtml}
</current_block>

ИНСТРУКЦИЯ ПОЛЬЗОВАТЕЛЯ:
${userComment}

ПРАВИЛА:
1. Верни ТОЛЬКО обновлённый HTML блока — один корневой элемент <section data-block-id="..." data-block-type="...">
2. Сохрани ВСЕ data-атрибуты (data-block-id, data-block-type, data-company-rank) без изменений
3. Используй ТОЛЬКО те CSS-классы, custom properties (:root переменные) и шрифты, которые определены в стилевом контексте
4. Если пользователь просит изменить визуал но сохранить текст — сохрани весь текстовый контент дословно
5. Не добавляй новые <style>, <link> или <script> теги
6. Не используй inline-стили, которые конфликтуют с существующими CSS custom properties
7. Формат ответа: только HTML, без пояснений, без markdown, без обёрток в тройные бэктики`;

      try {
        showEditorNotification(iDoc, 'Регенерация блока...', false);
        const data = await callModel("anthropic/claude-haiku-4.5", [{ role: "user", content: regenPrompt }], apiKey);

        if (data.error) {
          loader.remove();
          showEditorNotification(iDoc, 'Ошибка регенерации: ' + data.error, true);
          editorUndo();
          return;
        }

        let newHtml = data.content;
        newHtml = newHtml.replace(/^```html?\s*\n?/i, '').replace(/\n?```\s*$/i, '').trim();

        block.outerHTML = newHtml;
        loader.remove();
        syncCanvasRawHtml();
        // Re-inject editor listeners in both inline and window editor modes
        const isEditorWin = editorWindow && !editorWindow.closed && iDoc === editorWindow.document;
        if (editorActive || isEditorWin) injectEditorListeners(iDoc);
        showEditorNotification(iDoc, 'Блок обновлён', false);
      } catch (err) {
        loader.remove();
        showEditorNotification(iDoc, 'Ошибка регенерации: ' + err.message, true);
        editorUndo();
      }
    }

    function removeEditorOverlays(iDoc) {
      if (!iDoc) return;
      // Remove injected style
      const style = iDoc.getElementById('__editor_style__');
      if (style) style.remove();
      // Remove all toolbars and popups
      iDoc.querySelectorAll('.__editor_toolbar__, .__editor_comment_popup__, .__editor_loader__').forEach(el => el.remove());
      // Remove hover classes
      iDoc.querySelectorAll('.__editor_hover__').forEach(el => el.classList.remove('__editor_hover__'));
      // Remove event listeners
      if (iDoc.body?.__editorMouseOver) {
        iDoc.body.removeEventListener('mouseover', iDoc.body.__editorMouseOver);
        iDoc.body.removeEventListener('mouseout', iDoc.body.__editorMouseOut);
        delete iDoc.body.__editorMouseOver;
        delete iDoc.body.__editorMouseOut;
      }
    }

    // =============================================
    // 3B.7 — Download HTML
    // =============================================
    function downloadHtml() {
      const iframe = document.getElementById('canvas-iframe');
      const iDoc = iframe.contentDocument;
      if (!iDoc) return showNotification('Нет сгенерированного сайта', true);

      // Clone the document to clean up editor artifacts
      let html = '<!DOCTYPE html>' + iDoc.documentElement.outerHTML;

      // Remove editor artifacts
      html = html.replace(/<style id="__editor_style__">[\s\S]*?<\/style>/g, '');
      html = html.replace(/<style id="__editor_spin_style__">[\s\S]*?<\/style>/g, '');
      html = html.replace(/<div class="__editor_toolbar__">[\s\S]*?<\/div>/g, '');
      html = html.replace(/<div class="__editor_comment_popup__">[\s\S]*?<\/div>/g, '');
      html = html.replace(/<div class="__editor_loader__">[\s\S]*?<\/div>/g, '');
      html = html.replace(/ ?class="__editor_hover__"/g, '');
      html = html.replace(/ ?class="__editor_collapsed__"/g, '');
      // Clean outline inline styles added by editor
      html = html.replace(/ style="position: relative;"/g, '');

      const dlProject = currentProjectId ? getProjects().find(p => p.id === currentProjectId) : null;
      const dlNiche = dlProject?.niche || 'site';
      const dateStr = new Date().toISOString().slice(0, 10);
      const filename = `rating-${dlNiche.replace(/[^a-zA-Zа-яА-Я0-9]/g, '_')}-${dateStr}.html`;

      const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // =============================================
    // Keyboard shortcuts for undo/redo (main window iframe)
    // =============================================
    document.addEventListener('keydown', (e) => {
      if (!editorActive) return;
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        editorUndo();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
        e.preventDefault();
        editorRedo();
      }
    });

    // =============================================
    // Правка #8 — Editor in separate window (window.open)
    // =============================================
    let editorWindow = null;
    let editorWindowDirty = false;

    function openInEditor() {
      if (!canvasRawHtml) return showNotification('Сначала сгенерируйте сайт', true);

      editorWindow = window.open('', '_blank');
      if (!editorWindow) return showNotification('Браузер заблокировал popup — разрешите всплывающие окна', true);

      editorWindow.document.open();
      editorWindow.document.write(canvasRawHtml);
      editorWindow.document.close();

      // Wait for document to load, then inject editor
      editorWindow.addEventListener('load', () => {
        injectEditor(editorWindow);
      });
      // Fallback if load already fired
      setTimeout(() => {
        if (editorWindow && editorWindow.document.body && !editorWindow.document.getElementById('__ew_toolbar__')) {
          injectEditor(editorWindow);
        }
      }, 500);
    }

    function injectEditor(win) {
      const doc = win.document;

      // Pass config to editor window
      const edProject = currentProjectId ? getProjects().find(p => p.id === currentProjectId) : null;
      win.__EDITOR_CONFIG__ = {
        apiKey: localStorage.getItem("openrouter_key") || '',
        model: 'anthropic/claude-haiku-4.5',
        siteLang: edProject?.site_lang || 'Русский',
        projectId: currentProjectId
      };

      // Add padding-top for toolbar
      doc.body.style.paddingTop = '50px';

      // Inject toolbar
      const toolbar = doc.createElement('div');
      toolbar.id = '__ew_toolbar__';
      toolbar.innerHTML = `
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="checkbox" id="__ew_edit_toggle__"> Редактирование
        </label>
        <button id="__ew_undo__" disabled style="opacity:0.4;">↩ Отменить</button>
        <button id="__ew_redo__" disabled style="opacity:0.4;">↪ Повторить</button>
        <span style="flex:1;"></span>
        <button id="__ew_seo__">SEO</button>
        <button id="__ew_save__" style="background:#238636;border-color:#238636;color:#fff;">Сохранить</button>
        <button id="__ew_download__" style="background:#1f6feb;border-color:#1f6feb;color:#fff;">Скачать HTML</button>
      `;
      Object.assign(toolbar.style, {
        position: 'fixed', top: '0', left: '0', right: '0', zIndex: '99999',
        height: '44px', display: 'flex', alignItems: 'center', gap: '8px',
        padding: '0 16px', background: '#1c2128', borderBottom: '1px solid #30363d',
        fontFamily: '-apple-system,BlinkMacSystemFont,sans-serif', fontSize: '13px', color: '#e1e4e8'
      });
      // Style buttons
      const btnStyle = 'background:#21262d;border:1px solid #30363d;border-radius:6px;padding:5px 10px;color:#c9d1d9;cursor:pointer;font-size:12px;';
      toolbar.querySelectorAll('button').forEach(b => b.style.cssText += btnStyle);

      doc.body.insertBefore(toolbar, doc.body.firstChild);

      // Editor state for this window
      let ewEditorActive = false;
      let ewHistoryStack = [];
      let ewHistoryIndex = -1;

      function ewPushSnapshot() {
        const snap = doc.body.innerHTML;
        ewHistoryStack = ewHistoryStack.slice(0, ewHistoryIndex + 1);
        ewHistoryStack.push(snap);
        if (ewHistoryStack.length > 20) ewHistoryStack.shift();
        ewHistoryIndex = ewHistoryStack.length - 1;
        ewUpdateUndoRedo();
        editorWindowDirty = true;
      }

      function ewUndo() {
        if (ewHistoryIndex <= 0) return;
        ewHistoryIndex--;
        doc.body.innerHTML = ewHistoryStack[ewHistoryIndex];
        doc.body.style.paddingTop = '50px';
        if (ewEditorActive) ewInjectListeners();
        ewUpdateUndoRedo();
        ewSyncBack();
      }

      function ewRedo() {
        if (ewHistoryIndex >= ewHistoryStack.length - 1) return;
        ewHistoryIndex++;
        doc.body.innerHTML = ewHistoryStack[ewHistoryIndex];
        doc.body.style.paddingTop = '50px';
        if (ewEditorActive) ewInjectListeners();
        ewUpdateUndoRedo();
        ewSyncBack();
      }

      function ewUpdateUndoRedo() {
        const undo = doc.getElementById('__ew_undo__');
        const redo = doc.getElementById('__ew_redo__');
        if (undo) { undo.disabled = ewHistoryIndex <= 0; undo.style.opacity = ewHistoryIndex <= 0 ? '0.4' : '1'; }
        if (redo) { redo.disabled = ewHistoryIndex >= ewHistoryStack.length - 1; redo.style.opacity = ewHistoryIndex >= ewHistoryStack.length - 1 ? '0.4' : '1'; }
      }

      function ewSyncBack() {
        // Sync HTML back to main window
        const clean = ewGetCleanHtml();
        canvasRawHtml = clean;
        if (window.opener && !window.opener.closed) {
          window.opener.canvasRawHtml = clean;
        }
        editorWindowDirty = true;
      }

      function ewGetCleanHtml() {
        let html = '<!DOCTYPE html>' + doc.documentElement.outerHTML;
        // Remove editor toolbar
        html = html.replace(/<div id="__ew_toolbar__">[\s\S]*?<\/div>\s*/, '');
        // Remove editor styles and artifacts
        html = html.replace(/<style id="__editor_style__">[\s\S]*?<\/style>/g, '');
        html = html.replace(/<style id="__editor_spin_style__">[\s\S]*?<\/style>/g, '');
        html = html.replace(/<div class="__editor_toolbar__">[\s\S]*?<\/div>/g, '');
        html = html.replace(/<div class="__editor_comment_popup__">[\s\S]*?<\/div>/g, '');
        html = html.replace(/<div class="__editor_loader__">[\s\S]*?<\/div>/g, '');
        html = html.replace(/ ?class="__editor_hover__"/g, '');
        html = html.replace(/ ?class="__editor_collapsed__"/g, '');
        html = html.replace(/ style="position: relative;"/g, '');
        html = html.replace(/ style="padding-top: 50px;"/g, '');
        // Remove SEO panel if injected
        html = html.replace(/<div id="__ew_seo_panel__">[\s\S]*?<\/div>\s*<\/div>/g, '');
        return html;
      }

      // Toggle edit mode
      doc.getElementById('__ew_edit_toggle__').onchange = function() {
        ewEditorActive = this.checked;
        if (ewEditorActive) {
          if (ewHistoryStack.length === 0) ewPushSnapshot();
          ewInjectListeners();
        } else {
          removeEditorOverlays(doc);
        }
      };

      // Undo / Redo
      doc.getElementById('__ew_undo__').onclick = ewUndo;
      doc.getElementById('__ew_redo__').onclick = ewRedo;

      // Keyboard shortcuts
      doc.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
          e.preventDefault();
          ewUndo();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
          e.preventDefault();
          ewRedo();
        }
        // Ctrl+S = save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          ewSave();
        }
      });

      // Save to localStorage via opener
      function ewSave() {
        const clean = ewGetCleanHtml();
        canvasRawHtml = clean;
        if (window.opener && !window.opener.closed) {
          window.opener.canvasRawHtml = clean;
          if (window.opener.updateProjectHtml) window.opener.updateProjectHtml(clean);
          if (window.opener.updateProjectStatus) window.opener.updateProjectStatus('edited', clean);
        }

        editorWindowDirty = false;
        ewShowNotification('Сохранено');
      }

      doc.getElementById('__ew_save__').onclick = ewSave;

      // Download HTML
      doc.getElementById('__ew_download__').onclick = function() {
        const clean = ewGetCleanHtml();
        const openerProject = window.opener?.currentProjectId ? window.opener.getProjects().find(p => p.id === window.opener.currentProjectId) : null;
        const niche = openerProject?.niche || 'site';
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `rating-${niche.replace(/[^a-zA-Zа-яА-Я0-9]/g, '_')}-${dateStr}.html`;

        const blob = new Blob([clean], { type: 'text/html; charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = doc.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      };

      // SEO panel toggle
      doc.getElementById('__ew_seo__').onclick = function() {
        let panel = doc.getElementById('__ew_seo_panel__');
        if (panel) {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          return;
        }
        ewCreateSeoPanel();
      };

      function ewCreateSeoPanel() {
        const panel = doc.createElement('div');
        panel.id = '__ew_seo_panel__';
        Object.assign(panel.style, {
          position: 'fixed', top: '44px', right: '0', width: '360px', maxHeight: 'calc(100vh - 44px)',
          overflowY: 'auto', background: '#161b22', border: '1px solid #30363d', borderTop: 'none',
          zIndex: '99998', padding: '16px', fontFamily: '-apple-system,sans-serif', fontSize: '13px', color: '#e1e4e8'
        });
        const fields = [
          { id: 'counterYandex', label: 'Яндекс.Метрика', type: 'textarea' },
          { id: 'counterGoogle', label: 'Google Analytics / GTM', type: 'textarea' },
          { id: 'metaYandex', label: 'Яндекс.Вебмастер', type: 'input' },
          { id: 'metaGoogle', label: 'Google Search Console', type: 'input' },
          { id: 'metaTitle', label: 'Title', type: 'input' },
          { id: 'metaDesc', label: 'Description', type: 'textarea' },
          { id: 'metaKeywords', label: 'Keywords', type: 'input' },
          { id: 'metaOgImage', label: 'OG Image URL', type: 'input' }
        ];

        // Try to read current values from head
        const currentValues = ewReadSeoFromHead();

        panel.innerHTML = '<h3 style="margin:0 0 12px;font-size:14px;color:#fff;">SEO и счётчики</h3>' +
          fields.map(f => `
            <div style="margin-bottom:10px;">
              <label style="display:block;font-size:12px;color:#8b949e;margin-bottom:4px;">${f.label}</label>
              ${f.type === 'textarea'
                ? `<textarea id="__ew_${f.id}__" style="width:100%;min-height:60px;background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:8px;color:#e1e4e8;font-size:12px;resize:vertical;">${currentValues[f.id] || ''}</textarea>`
                : `<input id="__ew_${f.id}__" value="${currentValues[f.id] || ''}" style="width:100%;background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:8px;color:#e1e4e8;font-size:12px;">`}
            </div>
          `).join('') +
          '<button id="__ew_apply_seo__" style="width:100%;padding:8px;background:#238636;border:1px solid #238636;border-radius:6px;color:#fff;cursor:pointer;font-size:13px;">Применить</button>';

        doc.body.appendChild(panel);

        doc.getElementById('__ew_apply_seo__').onclick = function() {
          ewApplySeo();
        };
      }

      function ewReadSeoFromHead() {
        const vals = {};
        // Read meta title
        const title = doc.querySelector('title');
        if (title) vals.metaTitle = title.textContent;
        // Read meta description
        const desc = doc.querySelector('meta[name="description"]');
        if (desc) vals.metaDesc = desc.getAttribute('content') || '';
        // Read meta keywords
        const kw = doc.querySelector('meta[name="keywords"]');
        if (kw) vals.metaKeywords = kw.getAttribute('content') || '';
        // Read og:image
        const og = doc.querySelector('meta[property="og:image"]');
        if (og) vals.metaOgImage = og.getAttribute('content') || '';
        return vals;
      }

      function ewApplySeo() {
        ewPushSnapshot();
        const head = doc.head;

        // Apply counters inside PROTECTED:COUNTERS block
        const counterYandex = doc.getElementById('__ew_counterYandex__')?.value || '';
        const counterGoogle = doc.getElementById('__ew_counterGoogle__')?.value || '';
        let countersContent = '';
        if (counterYandex) countersContent += counterYandex + '\n';
        if (counterGoogle) countersContent += counterGoogle + '\n';

        const headHtml = head.innerHTML;
        if (headHtml.includes('<!-- PROTECTED:COUNTERS:START -->')) {
          head.innerHTML = headHtml.replace(
            /<!-- PROTECTED:COUNTERS:START -->[\s\S]*?<!-- PROTECTED:COUNTERS:END -->/,
            `<!-- PROTECTED:COUNTERS:START -->\n${countersContent}<!-- PROTECTED:COUNTERS:END -->`
          );
        }

        // Apply SEO meta inside PROTECTED:SEO block
        const metaYandex = doc.getElementById('__ew_metaYandex__')?.value || '';
        const metaGoogle = doc.getElementById('__ew_metaGoogle__')?.value || '';
        const metaTitle = doc.getElementById('__ew_metaTitle__')?.value || '';
        const metaDesc = doc.getElementById('__ew_metaDesc__')?.value || '';
        const metaKeywords = doc.getElementById('__ew_metaKeywords__')?.value || '';
        const metaOgImage = doc.getElementById('__ew_metaOgImage__')?.value || '';

        let seoContent = '';
        if (metaYandex) seoContent += `<meta name="yandex-verification" content="${metaYandex}">\n`;
        if (metaGoogle) seoContent += `<meta name="google-site-verification" content="${metaGoogle}">\n`;
        if (metaTitle) {
          const titleEl = doc.querySelector('title');
          if (titleEl) titleEl.textContent = metaTitle;
        }
        if (metaDesc) seoContent += `<meta name="description" content="${metaDesc}">\n`;
        if (metaKeywords) seoContent += `<meta name="keywords" content="${metaKeywords}">\n`;
        if (metaOgImage) seoContent += `<meta property="og:image" content="${metaOgImage}">\n`;

        const headHtml2 = head.innerHTML;
        if (headHtml2.includes('<!-- PROTECTED:SEO:START -->')) {
          head.innerHTML = headHtml2.replace(
            /<!-- PROTECTED:SEO:START -->[\s\S]*?<!-- PROTECTED:SEO:END -->/,
            `<!-- PROTECTED:SEO:START -->\n${seoContent}<!-- PROTECTED:SEO:END -->`
          );
        }

        ewSyncBack();
        ewShowNotification('SEO применено');
      }

      function ewShowNotification(msg) {
        let note = doc.getElementById('__ew_notification__');
        if (note) note.remove();
        note = doc.createElement('div');
        note.id = '__ew_notification__';
        Object.assign(note.style, {
          position: 'fixed', bottom: '20px', right: '20px', zIndex: '100000',
          background: '#238636', color: '#fff', padding: '10px 20px', borderRadius: '8px',
          fontSize: '13px', animation: 'fadeInOut 2.5s ease forwards'
        });
        // Add animation keyframes if needed
        if (!doc.getElementById('__ew_anim_style__')) {
          const animStyle = doc.createElement('style');
          animStyle.id = '__ew_anim_style__';
          animStyle.textContent = '@keyframes fadeInOut { 0%{opacity:0;transform:translateY(10px)} 15%{opacity:1;transform:translateY(0)} 80%{opacity:1} 100%{opacity:0} }';
          doc.head.appendChild(animStyle);
        }
        note.textContent = msg;
        doc.body.appendChild(note);
        setTimeout(() => note.remove(), 2500);
      }

      // Hover overlay + toolbar injection (same as 3B.2 but for editor window)
      function ewInjectListeners() {
        removeEditorOverlays(doc);
        injectEditorListeners(doc);

        // Override the callModel for regeneration to use editor window's apiKey
        // The existing injectEditorListeners/createBlockToolbar use the main window's functions
        // which reference iframe.contentDocument — but we're now using doc directly.
        // The functions (injectEditorListeners, createBlockToolbar, etc.) already accept iDoc parameter
        // so they work with any document. The regenerateBlock function uses document.getElementById("apiKey")
        // which will correctly reference the main window.
      }

      // Before unload warning
      win.addEventListener('beforeunload', (e) => {
        if (editorWindowDirty) {
          e.preventDefault();
          e.returnValue = 'Есть несохранённые изменения. Закрыть?';
        }
      });
    }

    function updatePreview() {
      const niche = document.getElementById("niche").value.trim();
      const geo = document.getElementById("geo").value.trim();
      const geoStr = geo ? ` в <span class="highlight">${geo}</span>` : '';
      document.getElementById("preview").innerHTML =
        `Составь список 30 <span class="highlight">${niche || "..."}</span>${geoStr}`;
    }

    function toggleApiKey() {
      const input = document.getElementById("apiKey");
      const btn = document.getElementById("toggleBtn");
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "скрыть";
      } else {
        input.type = "password";
        btn.textContent = "показать";
      }
    }

    function getBadgeClass(modelId) {
      if (modelId.includes("openai")) return "badge-chatgpt";
      if (modelId.includes("google")) return "badge-gemini";
      if (modelId.includes("anthropic")) return "badge-claude";
      return "";
    }

    function getBadgeLabel(modelId) {
      if (modelId.includes("openai")) return "ChatGPT";
      if (modelId.includes("google")) return "Gemini";
      if (modelId.includes("anthropic")) return "Claude";
      return "AI";
    }

    function renderCard(modelId) {
      const model = MODELS.find(m => m.id === modelId);
      const card = document.getElementById(`card-${CSS.escape(modelId)}`);
      if (!card || !model) return;

      const msgs = conversations[modelId] || [];
      const badgeClass = getBadgeClass(modelId);
      const badgeLabel = getBadgeLabel(modelId);

      let messagesHtml = "";
      for (const msg of msgs) {
        const isUser = msg.role === "user";
        messagesHtml += `
          <div class="chat-msg ${isUser ? "chat-msg-user" : "chat-msg-assistant"}">
            <div class="chat-msg-label">${isUser ? "Вы" : badgeLabel}</div>
            <div>${msg.content}</div>
          </div>`;
      }

      card.innerHTML = `
        <div class="result-header">
          <span class="model-badge ${badgeClass}">${badgeLabel}</span>
          <span class="model-name">${model.name}</span>
        </div>
        <div class="chat-messages" id="msgs-${CSS.escape(modelId)}">${messagesHtml}</div>
        <div class="chat-input-area">
          <input type="text" id="input-${CSS.escape(modelId)}" placeholder="Задать вопрос..." onkeydown="if(event.key==='Enter')sendFollowUp('${modelId}')" />
          <button onclick="sendFollowUp('${modelId}')">Отправить</button>
        </div>`;

      // Scroll chat to bottom
      const msgsEl = document.getElementById(`msgs-${CSS.escape(modelId)}`);
      if (msgsEl) msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    async function sendFollowUp(modelId) {
      const apiKey = localStorage.getItem("openrouter_key") || '';
      const inputEl = document.getElementById(`input-${CSS.escape(modelId)}`);
      const question = inputEl.value.trim();
      if (!question || !apiKey) return;

      // Add user message with language context
      const project = currentProjectId ? getProjects().find(p => p.id === currentProjectId) : null;
      const followUpLang = project?.query_lang || 'Русский';
      const followUpLangStr = `Отвечай на языке: ${followUpLang}`;
      conversations[modelId].push({ role: "user", content: `ЯЗЫК ОТВЕТА: ${followUpLangStr}\n\n${question}` });
      inputEl.value = "";
      renderCard(modelId);

      // Show loading
      const msgsEl = document.getElementById(`msgs-${CSS.escape(modelId)}`);
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "chat-msg chat-msg-assistant";
      loadingDiv.innerHTML = `<div class="chat-msg-label">${getBadgeLabel(modelId)}</div><div><span class="spinner-small"></span> Думает...</div>`;
      msgsEl.appendChild(loadingDiv);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      // Disable input
      const btnEl = inputEl.nextElementSibling;
      inputEl.disabled = true;
      btnEl.disabled = true;

      try {
        const data = await callModel(modelId, conversations[modelId], apiKey);

        if (data.error) {
          conversations[modelId].push({ role: "assistant", content: `[Ошибка] ${data.error}` });
        } else {
          conversations[modelId].push({ role: "assistant", content: data.content });
        }
      } catch (err) {
        conversations[modelId].push({ role: "assistant", content: `[Ошибка] ${err.message}` });
      }

      inputEl.disabled = false;
      btnEl.disabled = false;
      renderCard(modelId);
    }

    // === Pipeline Execution (server-side via SSE) ===
    let pipelineRunning = false;
    let eventSource = null;

    async function runPipeline(projectId, startFrom = null) {
      if (pipelineRunning) return showNotification('Пайплайн уже запущен', true);

      const apiKey = localStorage.getItem('openrouter_key');
      if (!apiKey) return alert('Нет API-ключа OpenRouter');

      // Hide resume bar
      const resumeBar = document.getElementById('project-resume-bar');
      if (resumeBar) resumeBar.innerHTML = '';

      const resp = await fetch(`/api/projects/${projectId}/pipeline/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apiKey, startFrom }),
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: 'Ошибка запуска' }));
        return showNotification(err.error || 'Ошибка запуска', true);
      }

      pipelineRunning = true;
      connectPipelineSSE(projectId);
    }

    async function stopPipeline(projectId) {
      await fetch(`/api/projects/${projectId}/pipeline/stop`, { method: 'POST' });
    }

    function connectPipelineSSE(projectId) {
      if (eventSource) eventSource.close();
      eventSource = new EventSource(`/api/projects/${projectId}/pipeline/events`);

      eventSource.addEventListener('step_start', (e) => {
        const { step } = JSON.parse(e.data);
        updateTimelineStep(step, 'running');
        showStepSection(step);
      });

      eventSource.addEventListener('step_progress', (e) => {
        const { step, message } = JSON.parse(e.data);
        updateStepProgress(step, message);
      });

      eventSource.addEventListener('step_done', (e) => {
        const d = JSON.parse(e.data);
        updateTimelineStep(d.step, 'done');
        if (d.data) renderStepResult(d.step, d.data);
      });

      eventSource.addEventListener('step_error', (e) => {
        const { step, error } = JSON.parse(e.data);
        updateTimelineStep(step, 'error');
        showNotification(`Ошибка на шаге: ${error}`, true);
      });

      eventSource.addEventListener('pipeline_done', () => {
        pipelineRunning = false;
        showNotification('Пайплайн завершён');
        if (eventSource) { eventSource.close(); eventSource = null; }
        refreshProject(currentProjectId);
      });

      eventSource.addEventListener('pipeline_error', (e) => {
        const { error } = JSON.parse(e.data);
        pipelineRunning = false;
        showNotification(`Ошибка пайплайна: ${error}`, true);
        if (eventSource) { eventSource.close(); eventSource = null; }
      });

      eventSource.addEventListener('pipeline_stopped', () => {
        pipelineRunning = false;
        showNotification('Пайплайн остановлен');
        if (eventSource) { eventSource.close(); eventSource = null; }
      });
    }

    function showStepSection(step) {
      const map = {
        'step_3': 'grok-section',
        'step_4': 'audience-section',
        'step_design': 'design-section',
        'step_5': 'compiler-section',
        'step_6': 'canvas-section',
        'step_7': 'ratings-section',
        'step_8_web': 'ratings-section',
        'step_fill': 'fill-section',
      };
      const id = map[step];
      if (id) {
        const el = document.getElementById(id);
        if (el) { el.style.display = ''; el.scrollIntoView({ behavior: 'smooth' }); }
      }
      // Show loading states
      if (step === 'step_3') {
        const m = document.getElementById('grok-messages');
        if (m) m.innerHTML = '<div class="loading"><div class="spinner"></div>Grok анализирует критерии...</div>';
      } else if (step === 'step_4') {
        const m = document.getElementById('audience-messages');
        if (m) m.innerHTML = '<div class="loading"><div class="spinner"></div>Grok анализирует аудитории...</div>';
      } else if (step === 'step_5') {
        const m = document.getElementById('compiler-messages');
        if (m) m.innerHTML = '<div class="loading"><div class="spinner"></div>Claude компилирует XML...</div>';
      } else if (step === 'step_6') {
        const l = document.getElementById('canvas-loading');
        if (l) l.style.display = 'flex';
        const t = document.getElementById('canvas-toolbar');
        if (t) t.style.display = 'none';
      } else if (step === 'step_7') {
        const l = document.getElementById('ratings-loading');
        if (l) l.style.display = 'flex';
      } else if (step === 'step_fill') {
        const l = document.getElementById('fill-loading');
        if (l) l.style.display = 'flex';
      }
    }

    function updateStepProgress(step, message) {
      if (step === 'step_8_web') {
        const p = document.getElementById('ratings-progress');
        if (p) p.textContent = message;
      } else if (step === 'step_1_2') {
        // Show progress in results area
        const r = document.getElementById('results');
        if (r && !r.querySelector('.result-card')) {
          r.innerHTML = `<div class="loading"><div class="spinner"></div>${message}</div>`;
        }
      }
    }

    function renderStepResult(step, data) {
      if (step === 'step_1_2' && data.conversations) {
        Object.assign(conversations, data.conversations);
        const resultsDiv = document.getElementById('results');
        if (resultsDiv) {
          resultsDiv.innerHTML = MODELS.map(m => `
            <div class="result-card" id="card-${CSS.escape(m.id)}">
              <div class="result-header">
                <span class="model-badge ${getBadgeClass(m.id)}">${getBadgeLabel(m.id)}</span>
                <span class="model-name">${m.name}</span>
              </div>
              <div class="chat-messages" id="msgs-${CSS.escape(m.id)}"></div>
              <div class="chat-input-wrap"><input type="text" id="input-${CSS.escape(m.id)}" placeholder="Дополнительный вопрос..." onkeydown="if(event.key==='Enter')chatSend('${m.id}')"><button onclick="chatSend('${m.id}')">Отправить</button></div>
            </div>`).join('');
          MODELS.forEach(m => renderCard(m.id));
        }
      } else if (step === 'step_3' && data.grokCriteriaRaw) {
        const msgs = document.getElementById('grok-messages');
        if (msgs) {
          const tableHtml = mdTableToHtml(data.grokCriteriaRaw);
          const rendered = tableHtml
            ? `<div class="grok-table-wrap">${tableHtml}</div>`
            : `<div style="white-space:pre-wrap">${data.grokCriteriaRaw}</div>`;
          msgs.innerHTML = `<div class="chat-msg chat-msg-assistant" style="padding:20px;">${rendered}</div>`;
        }
      } else if (step === 'step_4' && data.grokAudienceRaw) {
        const msgs = document.getElementById('audience-messages');
        if (msgs) {
          const parsed = parseAudienceResponse(data.grokAudienceRaw);
          if (parsed) {
            msgs.innerHTML = `<div class="chat-msg chat-msg-assistant" style="padding:20px;"><div class="grok-table-wrap">${parsed.tableHtml}</div>${parsed.portraitsHtml}</div>`;
          } else {
            msgs.innerHTML = `<div class="chat-msg chat-msg-assistant" style="padding:20px;"><div style="white-space:pre-wrap">${data.grokAudienceRaw}</div></div>`;
          }
        }
      } else if (step === 'step_design' && data.designSystemRaw) {
        const msgs = document.getElementById('design-messages');
        if (msgs) {
          const note = data.designQuery ? `<div style="margin-bottom:12px; padding:8px 12px; background:#1a1f35; border-radius:6px; font-size:12px; color:#7ee787;">Запрос BM25: "${data.designQuery}"</div>` : '';
          msgs.innerHTML = `<div class="chat-msg chat-msg-assistant" style="padding:20px"><div class="chat-msg-label">Design System (BM25)</div>${note}<div style="white-space:pre-wrap; font-size:12px; color:#8b949e">${data.designSystemRaw.replace(/</g, '&lt;')}</div></div>`;
        }
      } else if (step === 'step_5' && data.compilerRawXml) {
        compilerRawXml = data.compilerRawXml;
        const msgs = document.getElementById('compiler-messages');
        if (msgs) {
          msgs.innerHTML = `<div class="chat-msg chat-msg-assistant" style="padding:20px;"><button class="copy-btn" onclick="navigator.clipboard.writeText(compilerRawXml).then(()=>{this.textContent='Скопировано!';setTimeout(()=>this.textContent='Копировать XML',1500)})">Копировать XML</button><div class="xml-output">${highlightXml(data.compilerRawXml)}</div></div>`;
        }
      } else if (step === 'step_6') {
        refreshProjectHtml(currentProjectId);
      } else if (step === 'step_7' && data.extractedRatings) {
        extractedRatings = data.extractedRatings;
        const l = document.getElementById('ratings-loading');
        if (l) l.style.display = 'none';
        renderRatingsGrid();
      } else if (step === 'step_8_web' && data.extractedRatings) {
        extractedRatings = data.extractedRatings;
        renderRatingsGrid();
      } else if (step === 'step_fill') {
        const fl = document.getElementById('fill-loading');
        if (fl) fl.style.display = 'none';
        const fm = document.getElementById('fill-messages');
        if (fm) fm.innerHTML = `<div class="chat-msg chat-msg-assistant" style="padding:12px"><div style="font-size:12px; color:#7ee787;">Сайт наполнен реальными данными компаний</div></div>`;
        refreshProjectHtml(currentProjectId);
      }
    }

    async function refreshProjectHtml(projectId) {
      const htmlResp = await fetch(`/api/projects/${projectId}/html`);
      if (!htmlResp.ok) return;
      canvasRawHtml = await htmlResp.text();

      const canvasSection = document.getElementById('canvas-section');
      if (canvasSection) {
        canvasSection.style.display = 'block';
        document.getElementById('canvas-toolbar').style.display = 'flex';
        document.getElementById('editor-toolbar').style.display = 'flex';
        document.getElementById('canvas-preview').style.display = 'block';
        document.getElementById('canvas-loading').style.display = 'none';

        editorActive = false;
        historyStack = [];
        historyIndex = -1;

        const iframe = document.getElementById('canvas-iframe');
        if (iframe) iframe.srcdoc = canvasRawHtml;
        const codeContent = document.getElementById('canvas-code-content');
        if (codeContent) codeContent.textContent = canvasRawHtml;
      }
    }

    async function refreshProject(projectId) {
      if (projectId) await renderProject(projectId);
    }

    // Restore saved API key
    const savedKey = localStorage.getItem("openrouter_key");
    if (savedKey) document.getElementById("apiKey").value = savedKey;

    // Start SPA router
    router();
  </script>
</body>
</html>
