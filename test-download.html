<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тест скачивания сайтов</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f1117;
      color: #e1e4e8;
      min-height: 100vh;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    h1 { text-align: center; font-size: 24px; margin-bottom: 8px; color: #fff; }
    .subtitle { text-align: center; color: #8b949e; margin-bottom: 32px; font-size: 14px; }

    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 { font-size: 16px; margin-bottom: 12px; color: #58a6ff; }

    .row { display: flex; gap: 8px; margin-bottom: 12px; }
    input[type="text"] {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #0d1117;
      color: #e1e4e8;
      font-size: 14px;
      outline: none;
    }
    input:focus { border-color: #58a6ff; }

    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary { background: #238636; color: #fff; }
    .btn-primary:hover { background: #2ea043; }
    .btn-primary:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }
    .btn-secondary { background: #30363d; color: #e1e4e8; }
    .btn-secondary:hover { background: #3d444d; }
    .btn-danger { background: #da3633; color: #fff; }
    .btn-danger:hover { background: #f85149; }

    .log {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 16px;
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 12px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log .ok { color: #238636; }
    .log .err { color: #f85149; }
    .log .warn { color: #d29922; }
    .log .info { color: #8b949e; }

    .companies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .company-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e1e4e8;
      font-size: 13px;
      cursor: pointer;
      text-align: left;
      width: 100%;
    }
    .company-btn:hover { border-color: #58a6ff; background: #1c2333; }
    .company-btn.status-done { border-color: #238636; }
    .company-btn.status-error { border-color: #f85149; }
    .company-btn.status-loading { border-color: #d29922; }

    .dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .dot.pending { background: #484f58; }
    .dot.loading { background: #d29922; animation: pulse 1s infinite; }
    .dot.done { background: #238636; }
    .dot.error { background: #f85149; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .progress { font-size: 13px; color: #8b949e; margin-bottom: 10px; }

    .preview-frame {
      width: 100%; height: 500px;
      border: 1px solid #30363d; border-radius: 8px;
      background: #fff;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #0d1117;
      color: #e1e4e8;
      font-family: "SF Mono", monospace;
      font-size: 12px;
      resize: vertical;
      outline: none;
    }
    textarea:focus { border-color: #58a6ff; }

    .back-link { display: inline-block; margin-bottom: 20px; color: #58a6ff; text-decoration: none; font-size: 14px; }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">← Назад к генератору</a>
    <h1>Тест скачивания сайтов через CORS-прокси</h1>
    <p class="subtitle">Проверяйте, работают ли прокси, до запуска основного пайплайна</p>

    <!-- Тест одного URL -->
    <div class="card">
      <h2>1. Тест одного URL</h2>
      <div class="row">
        <input type="text" id="singleUrl" placeholder="https://example.com" />
        <button class="btn-primary" onclick="testSingle()">Скачать</button>
      </div>
      <div class="log" id="singleLog"><span class="info">Введите URL и нажмите «Скачать»</span></div>
    </div>

    <!-- Тест прокси -->
    <div class="card">
      <h2>2. Проверка всех прокси (пинг)</h2>
      <p style="font-size:13px; color:#8b949e; margin-bottom:12px;">Скачает example.com через каждый прокси и покажет, какие работают</p>
      <button class="btn-primary" onclick="testAllProxies()">Проверить прокси</button>
      <div class="log" id="proxyLog" style="margin-top:12px;"><span class="info">Нажмите «Проверить прокси»</span></div>
    </div>

    <!-- Массовый тест -->
    <div class="card">
      <h2>3. Массовое скачивание (список URL)</h2>
      <p style="font-size:13px; color:#8b949e; margin-bottom:12px;">Вставьте список URL (по одному на строку) или JSON-массив [{name, url}]</p>
      <textarea id="bulkUrls" placeholder='https://site1.com
https://site2.com
https://site3.com

или JSON:
[{"name": "Сайт 1", "url": "https://site1.com"}, ...]'></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn-primary" id="bulkBtn" onclick="testBulk()">Скачать всё (5 потоков)</button>
        <button class="btn-danger" id="bulkStop" onclick="stopBulk()" style="display:none;">Стоп</button>
      </div>
      <div class="progress" id="bulkProgress"></div>
      <div class="companies-grid" id="bulkGrid"></div>
      <div id="bulkPreview" style="display:none; margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span id="previewTitle" style="font-size:14px; color:#58a6ff; font-weight:600;"></span>
          <button class="btn-secondary" onclick="document.getElementById('bulkPreview').style.display='none'">Закрыть</button>
        </div>
        <iframe id="previewIframe" class="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </div>
  </div>

  <script>
    // ========== CORS Proxy config (same as main app) ==========
    function getProxies(url) {
      const encoded = encodeURIComponent(url);
      return [
        { name: 'codetabs',   url: `https://api.codetabs.com/v1/proxy?quest=${encoded}`, type: 'raw' },
        { name: 'allorigins', url: `https://api.allorigins.win/get?url=${encoded}`, type: 'json', field: 'contents' },
        { name: 'corsproxy',  url: `https://corsproxy.io/?url=${encoded}`, type: 'raw' },
      ];
    }

    function extractText(html) {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      doc.querySelectorAll('script, style, svg, noscript, link, meta, header, footer, nav, iframe').forEach(el => el.remove());
      let text = doc.body?.innerText || '';
      return text.replace(/\n{3,}/g, '\n\n').replace(/[ \t]+/g, ' ').trim();
    }

    async function downloadSite(url, verbose) {
      const proxies = getProxies(url);
      const errors = [];

      for (const proxy of proxies) {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 15000);
          const start = Date.now();

          const resp = await fetch(proxy.url, { signal: controller.signal });
          clearTimeout(timeout);
          const elapsed = Date.now() - start;

          if (!resp.ok) {
            errors.push({ proxy: proxy.name, error: `HTTP ${resp.status}`, ms: elapsed });
            continue;
          }

          let html;
          if (proxy.type === 'json') {
            const data = await resp.json();
            html = data[proxy.field];
          } else {
            html = await resp.text();
          }

          if (!html || html.length < 100) {
            errors.push({ proxy: proxy.name, error: `пустой ответ (${(html||'').length} байт)`, ms: elapsed });
            continue;
          }

          const text = extractText(html).substring(0, 8000);
          return { ok: true, html, text, proxy: proxy.name, size: html.length, ms: elapsed, errors };
        } catch (e) {
          const reason = e.name === 'AbortError' ? 'таймаут 15с' : e.message;
          errors.push({ proxy: proxy.name, error: reason, ms: null });
          continue;
        }
      }

      return { ok: false, error: errors.map(e => `${e.proxy}: ${e.error}`).join(' → '), errors };
    }

    // ========== 1. Single URL test ==========
    async function testSingle() {
      const url = document.getElementById('singleUrl').value.trim();
      const log = document.getElementById('singleLog');
      if (!url) { log.innerHTML = '<span class="err">Введите URL</span>'; return; }

      log.innerHTML = '<span class="warn">⏳ Загрузка...</span>';

      const result = await downloadSite(url, true);

      if (result.ok) {
        let html = `<span class="ok">✅ Успех через ${result.proxy} (${result.ms}мс)</span>\n`;
        html += `<span class="info">Размер HTML: ${(result.size / 1024).toFixed(1)} KB</span>\n`;
        html += `<span class="info">Текст (первые 500 символов):</span>\n`;
        html += escapeHtml(result.text.substring(0, 500)) + '...\n';
        if (result.errors.length > 0) {
          html += `\n<span class="warn">⚠️ Другие прокси:</span>\n`;
          for (const e of result.errors) {
            html += `<span class="err">  ✗ ${e.proxy}: ${e.error}${e.ms ? ` (${e.ms}мс)` : ''}</span>\n`;
          }
        }
        log.innerHTML = html;
      } else {
        let html = '<span class="err">❌ Все прокси не сработали:</span>\n';
        for (const e of result.errors) {
          html += `<span class="err">  ✗ ${e.proxy}: ${e.error}${e.ms ? ` (${e.ms}мс)` : ''}</span>\n`;
        }
        log.innerHTML = html;
      }
    }

    // ========== 2. Proxy ping test ==========
    async function testAllProxies() {
      const log = document.getElementById('proxyLog');
      const testUrl = 'https://example.com';
      const proxies = getProxies(testUrl);

      log.innerHTML = '<span class="warn">⏳ Проверяю прокси...</span>\n';

      for (const proxy of proxies) {
        const line = document.createElement('span');
        line.className = 'warn';
        line.textContent = `  ⏳ ${proxy.name}...`;
        log.appendChild(document.createTextNode('\n'));
        log.appendChild(line);

        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 15000);
          const start = Date.now();

          const resp = await fetch(proxy.url, { signal: controller.signal });
          clearTimeout(timeout);
          const elapsed = Date.now() - start;

          if (!resp.ok) {
            line.className = 'err';
            line.textContent = `  ✗ ${proxy.name}: HTTP ${resp.status} (${elapsed}мс)`;
            continue;
          }

          let html;
          if (proxy.type === 'json') {
            const data = await resp.json();
            html = data[proxy.field];
          } else {
            html = await resp.text();
          }

          if (!html || html.length < 50) {
            line.className = 'err';
            line.textContent = `  ✗ ${proxy.name}: пустой ответ (${elapsed}мс)`;
          } else {
            line.className = 'ok';
            line.textContent = `  ✓ ${proxy.name}: OK (${(html.length/1024).toFixed(1)} KB, ${elapsed}мс)`;
          }
        } catch (e) {
          const reason = e.name === 'AbortError' ? 'таймаут 15с' : e.message;
          line.className = 'err';
          line.textContent = `  ✗ ${proxy.name}: ${reason}`;
        }
      }

      // Summary
      const okCount = log.querySelectorAll('.ok').length;
      const summary = document.createElement('span');
      summary.className = okCount > 0 ? 'ok' : 'err';
      summary.textContent = `\n${okCount > 0 ? '✅' : '❌'} Работает прокси: ${okCount} из ${proxies.length}`;
      log.appendChild(document.createTextNode('\n'));
      log.appendChild(summary);
    }

    // ========== 3. Bulk download ==========
    let bulkItems = [];
    let bulkResults = {};
    let bulkStopped = false;

    function parseBulkInput(text) {
      text = text.trim();

      // Try JSON first
      if (text.startsWith('[')) {
        try {
          const arr = JSON.parse(text);
          return arr.filter(item => item.url).map(item => ({
            name: item.name || new URL(item.url).hostname,
            url: item.url
          }));
        } catch {}
      }

      // Plain URLs
      return text.split('\n')
        .map(line => line.trim())
        .filter(line => line.startsWith('http'))
        .map(url => {
          try { return { name: new URL(url).hostname, url }; }
          catch { return null; }
        })
        .filter(Boolean);
    }

    function renderBulkGrid() {
      const grid = document.getElementById('bulkGrid');
      const progress = document.getElementById('bulkProgress');

      const done = bulkItems.filter(i => i.status === 'done').length;
      const errors = bulkItems.filter(i => i.status === 'error').length;
      const total = bulkItems.length;

      progress.textContent = `Загружено: ${done} из ${total}` + (errors > 0 ? ` (ошибок: ${errors})` : '');

      grid.innerHTML = bulkItems.map((item, idx) => {
        const tooltip = item.status === 'error'
          ? `Ошибка: ${item.errorReason || 'неизвестна'}\nURL: ${item.url}`
          : item.url;
        return `
        <button class="company-btn status-${item.status}"
                onclick="previewBulk(${idx})"
                title="${escapeAttr(tooltip)}">
          <span class="dot ${item.status}"></span>
          <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(item.name)}</span>
        </button>`;
      }).join('');
    }

    function previewBulk(idx) {
      const item = bulkItems[idx];
      if (!item) return;

      if (item.status === 'error') {
        alert(`Ошибка: ${item.name}\nURL: ${item.url}\nПричина: ${item.errorReason || 'неизвестна'}`);
        return;
      }
      if (item.status !== 'done') return;

      const wrap = document.getElementById('bulkPreview');
      const iframe = document.getElementById('previewIframe');
      const title = document.getElementById('previewTitle');

      title.textContent = `${item.name} — ${item.url}`;
      iframe.srcdoc = bulkResults[item.name]?.html || '<p>Нет данных</p>';
      wrap.style.display = 'block';
      wrap.scrollIntoView({ behavior: 'smooth' });
    }

    async function testBulk() {
      const text = document.getElementById('bulkUrls').value;
      const items = parseBulkInput(text);
      if (items.length === 0) {
        document.getElementById('bulkProgress').textContent = 'Не найдено URL. Введите список URL или JSON.';
        return;
      }

      bulkItems = items.map(i => ({ ...i, status: 'pending', errorReason: '' }));
      bulkResults = {};
      bulkStopped = false;

      document.getElementById('bulkBtn').disabled = true;
      document.getElementById('bulkStop').style.display = 'inline-block';
      renderBulkGrid();

      // Queue with 5 workers
      const queue = [...bulkItems.keys()];

      async function worker() {
        while (queue.length > 0 && !bulkStopped) {
          const idx = queue.shift();
          const item = bulkItems[idx];

          item.status = 'loading';
          renderBulkGrid();

          const result = await downloadSite(item.url, true);

          if (bulkStopped) break;

          if (result.ok) {
            bulkResults[item.name] = { html: result.html, text: result.text };
            item.status = 'done';
          } else {
            item.status = 'error';
            item.errorReason = result.error;
          }
          renderBulkGrid();
        }
      }

      const workers = Array.from(
        { length: Math.min(5, bulkItems.length) },
        () => worker()
      );

      await Promise.all(workers);

      document.getElementById('bulkBtn').disabled = false;
      document.getElementById('bulkStop').style.display = 'none';
    }

    function stopBulk() {
      bulkStopped = true;
      document.getElementById('bulkBtn').disabled = false;
      document.getElementById('bulkStop').style.display = 'none';
      // Mark remaining as error
      bulkItems.forEach(item => {
        if (item.status === 'pending' || item.status === 'loading') {
          item.status = 'error';
          item.errorReason = 'Остановлено пользователем';
        }
      });
      renderBulkGrid();
    }

    // ========== Helpers ==========
    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function escapeAttr(str) {
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/\n/g, '&#10;');
    }
  </script>
</body>
</html>
